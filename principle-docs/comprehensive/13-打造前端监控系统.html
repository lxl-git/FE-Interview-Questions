<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、性能优化方法论 | 前端进阶之旅</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/FE-Interview-Questions/logo.png">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <link rel="apple-touch-icon" href="/FE-Interview-Questions/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/FE-Interview-Questions/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <link rel="manifest" href="/FE-Interview-Questions/manifest.json">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?0219e9e99d6bcc9481a4d5b9a865853a";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <meta name="description" content="前端面试题进阶总结，按模块分类精心整理，打造最全面的前端面试题库，为你的前端面试之旅保驾护航！">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="robots" content="all">
    <meta name="author" content="程序员poetry">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="程序员poetry，前端进阶之旅，前端面试之旅, 前端面试指南，前端进阶之旅，前端进阶学习路线,前端笔记整理,前端面试宝典, 前端面经手册，前端系统进阶笔记整理">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/FE-Interview-Questions/assets/css/0.styles.66e7d4f5.css" as="style"><link rel="preload" href="/FE-Interview-Questions/assets/js/app.afe030bd.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/3.b54a8b6a.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/5.a9c334eb.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/248.d1bf3d2f.js" as="script"><link rel="preload" href="/FE-Interview-Questions/assets/js/11.fd3c8703.js" as="script">
    <link rel="stylesheet" href="/FE-Interview-Questions/assets/css/0.styles.66e7d4f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container posr"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FE-Interview-Questions/" class="home-link router-link-active"><img src="/FE-Interview-Questions/logo.png" alt="前端进阶之旅" class="logo"> <span class="site-name can-hide">前端进阶之旅</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----> <span class="login-btn"><i class="el-tooltip el-icon-user-solid item">登录</i></span></div></header></div> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>综合</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/01-虚拟DOM原理分析.html" class="sidebar-link">虚拟DOM原理分析</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/02-setTimeout实现原理和使用注意.html" class="sidebar-link">setTimeout实现原理和使用注意</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/03-浅析Promise原理.html" class="sidebar-link">浅析Promise原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/04-浏览器渲染原理.html" class="sidebar-link">浏览器渲染原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/05-前端面试之MVVM浅析.html" class="sidebar-link">前端面试之MVVM浅析</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/06-前端面试之组件化.html" class="sidebar-link">前端面试之组件化</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/07-虚拟DOM（一）.html" class="sidebar-link">虚拟DOM（一）</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/08-虚拟DOM（二）.html" class="sidebar-link">虚拟DOM（二）</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/09-前端性能之Performance.html" class="sidebar-link">前端性能之Performance</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/10-小程序开发实践.html" class="sidebar-link">小程序开发实践</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/11-对比 Koa 和 Redux-分析前端中的中间件理念.html" class="sidebar-link">对比 Koa 和 Redux</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/12-正则完整篇.html" class="sidebar-link">正则完整篇</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html" class="active sidebar-link">打造前端监控系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#一、性能优化方法论" class="sidebar-link">一、性能优化方法论</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#二、指标采集-首屏时间指标采集具体办法" class="sidebar-link">二、指标采集：首屏时间指标采集具体办法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#手动采集办法及优缺点" class="sidebar-link">手动采集办法及优缺点：</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#自动化采集优势及办法" class="sidebar-link">自动化采集优势及办法</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#单页面-spa-应用业务下的采集办法" class="sidebar-link">单页面（SPA）应用业务下的采集办法</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#三、指标采集-白屏、卡顿、网络环境指标采集方法" class="sidebar-link">三、指标采集：白屏、卡顿、网络环境指标采集方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#白屏指标采集" class="sidebar-link">白屏指标采集</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#卡顿指标采集" class="sidebar-link">卡顿指标采集</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#四、工具实践-性能-sdk-及上报策略设计" class="sidebar-link">四、工具实践：性能 SDK 及上报策略设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#sdk-接入设计" class="sidebar-link">SDK 接入设计</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#sdk-运行设计" class="sidebar-link">SDK 运行设计</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#日志数据过滤" class="sidebar-link">日志数据过滤</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#数据抽样策略" class="sidebar-link">数据抽样策略</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#上报机制选择" class="sidebar-link">上报机制选择</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#五、平台实践-如何从-0-到-1-搭建前端性能平台" class="sidebar-link">五、平台实践：如何从 0 到 1 搭建前端性能平台</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#性能数据处理后台" class="sidebar-link">性能数据处理后台</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#前端数据可视化展示前台" class="sidebar-link">前端数据可视化展示前台</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#六、诊断清单-如何实现监控预警并进行问题诊断" class="sidebar-link">六、诊断清单：如何实现监控预警并进行问题诊断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#监控预警" class="sidebar-link">监控预警</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#问题诊断" class="sidebar-link">问题诊断</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#七、优化手段-首屏秒开的-4-重保障" class="sidebar-link">七、优化手段：首屏秒开的 4 重保障</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#懒加载" class="sidebar-link">懒加载</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#接口缓存" class="sidebar-link">接口缓存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#静态资源缓存" class="sidebar-link">静态资源缓存</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#离线化" class="sidebar-link">离线化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#并行化" class="sidebar-link">并行化</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#八、优化手段-白屏-300ms-和界面流畅优化技巧" class="sidebar-link">八、优化手段：白屏 300ms 和界面流畅优化技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#白屏优化" class="sidebar-link">白屏优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#dns-查询优化" class="sidebar-link">DNS 查询优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#首字符展示优化" class="sidebar-link">首字符展示优化</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#卡顿治理" class="sidebar-link">卡顿治理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#浏览器的主线程与合成线程调度不合理" class="sidebar-link">浏览器的主线程与合成线程调度不合理</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#计算耗时操作" class="sidebar-link">计算耗时操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#九、js-sdk-设计" class="sidebar-link">九、JS SDK 设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#performance" class="sidebar-link">Performance</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#错误监控" class="sidebar-link">错误监控</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#数据处理和展示" class="sidebar-link">数据处理和展示</a></li></ul></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#十、前端监控系统实战" class="sidebar-link">十、前端监控系统实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#没有前端监控下的痛点有哪些" class="sidebar-link">没有前端监控下的痛点有哪些</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#手动搭建一个前端监控系统" class="sidebar-link">手动搭建一个前端监控系统</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#js-sdk-功能设计" class="sidebar-link">JS SDK 功能设计</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#服务端接收数据-并记录日志" class="sidebar-link">服务端接收数据，并记录日志</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#数据收集与过滤" class="sidebar-link">数据收集与过滤</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#数据存储-es-提供分析和查询能力" class="sidebar-link">数据存储（ES）提供分析和查询能力</a></li><li class="sidebar-sub-header"><a href="/FE-Interview-Questions/principle-docs/comprehensive/13-打造前端监控系统.html#告警配置" class="sidebar-link">告警配置</a></li></ul></li></ul></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/14-浏览器渲染机制.html" class="sidebar-link">浏览器渲染机制</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/15-前端缓存方案解析.html" class="sidebar-link">前端缓存方案解析</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/16-小程序原理.html" class="sidebar-link">小程序原理</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/17-深入剖析浏览器中页面的渲染过程.html" class="sidebar-link">深入剖析浏览器中页面的渲染过程</a></li><li><a href="/FE-Interview-Questions/principle-docs/comprehensive/18-一个网络请求是怎么进行的.html" class="sidebar-link">一个网络请求是怎么进行的</a></li></ul></section></li></ul> </aside> <main class="page"> <div id="container" class="theme-default-content lock"><div class="content__default"><h2 id="一、性能优化方法论"><a href="#一、性能优化方法论" class="header-anchor">#</a> 一、性能优化方法论</h2> <p><img alt="" data-src="https://s.poetries.work/images/20210502210714.png" loading="lazy" class="lazy"></p> <blockquote><p>首屏时间可以拆分为白屏时间、数据接口响应时间、图片加载资源等</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210502214539.png" loading="lazy" class="lazy"></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503212926.png" loading="lazy" class="lazy"></p> <h2 id="二、指标采集-首屏时间指标采集具体办法"><a href="#二、指标采集-首屏时间指标采集具体办法" class="header-anchor">#</a> 二、指标采集：首屏时间指标采集具体办法</h2> <h3 id="手动采集办法及优缺点"><a href="#手动采集办法及优缺点" class="header-anchor">#</a> 手动采集办法及优缺点：</h3> <ul><li>所谓手动采集，一般是通过埋点的方式进行， 比如在页面开始位置打上 <code>FMP.Start()</code>，在首屏结束位置打上 <code>FMP.End()</code>，利用 <code>FMP.End()-FMP.Start()</code> 获取到首屏时间。</li> <li>手动采集的统计结果并不精确，因为依赖于人，每个人对首屏的理解有偏差，经常打错或者忘记打点。</li></ul> <h3 id="自动化采集优势及办法"><a href="#自动化采集优势及办法" class="header-anchor">#</a> 自动化采集优势及办法</h3> <blockquote><p>所谓自动化采集，即引入一段通用的代码来做首屏时间自动化采集，引入过程中，除了必要的配置不需要做其他事情。</p></blockquote> <p>自动化采集的好处是独立性更强，接入过程更自动化。具体的自动化采集代码，可以由一个公共团队来开发，试点后，推广到各个业务团队。而且统计结果更标准化，同一段统计代码，标准更统一，业务侧同学也更认可这个统计结果。</p> <p>当然，它也有缺点，最明显的是，有些个性化需求无法满足，毕竟在工作中，总会有一些特殊业务场景。所以，采用自动化采集方案必须做一些取舍。</p> <h3 id="单页面-spa-应用业务下的采集办法"><a href="#单页面-spa-应用业务下的采集办法" class="header-anchor">#</a> 单页面（SPA）应用业务下的采集办法</h3> <p>SPA 页面因为无法基于 <code>DOMContentLoaded</code> 做首屏指标采集，可以使用 <code>MutationObserver</code> 采集首屏时间。</p> <blockquote><p><code>MutationObserver</code> 接口提供了监视对 DOM 树所做更改的能力。它被设计为旧的 <code>Mutation Events</code> 功能的替代品，该功能是 DOM3 Events 规范的一部分。</p></blockquote> <p>简单来说， 使用 <code>MutationObserver 能监控页面信息的变化</code>，当页面 <code>body</code> 变化最剧烈的时候，我们拿到的时间数据，就是<code>首屏时间</code>。</p> <p>首先，在用户进入页面时，我们可以使用 <code>MutationObserver</code> 监控 <code>DOM</code> 元素 （Document Object Model，文档对象模型）。当 DOM 元素发生变化时，程序会标记变化的元素，记录时间点和分数，存储到数组中。数据的格式类似于 <code>[200ms,18.5]</code>。</p> <p>为了提升计算的效率，我们认为首屏指标采集到某些条件时，首屏渲染已经结束，我们需要考虑首屏采集终止的条件，即计算时间超过 30 秒还没有结束；计算了 4 轮且 1 秒内分数不再变化；计算了 9 次且分数不再变化。</p> <p>接下来，设定元素权重计算分数。</p> <p>递归遍历 DOM 元素及其子元素，根据子元素所在层数设定元素权重，比如第一层元素权重是 1，当它被渲染时得 1 分，每增加一层权重增加 0.5，比如第五层元素权重是 3.5，渲染时给出对应分数。</p> <p>为什么需要权重呢？</p> <p>因为页面中每个 DOM 元素对于首屏的意义是不同的，越往内层越接近真实的首屏内容，如图片和文字，越往外层越接近 body 等框架层。</p> <p>最后，根据前面的得分，计算元素的分数变化率，获取变化率最大点对应的分数。然后找到该分数对应的时间，即为首屏时间。</p> <p>分数部分核心计算逻辑是递归遍历元素，将一些无用的标签排除，如果元素超过可视范围返回 0 分，每一层增加 0.5 的权重，具体请看下面代码示例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">CScor</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> tiers<span class="token punctuation">,</span> parentScore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> el<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;SCRIPT&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;STYLE&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;META&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">!==</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childrenLen <span class="token operator">=</span> el<span class="token punctuation">.</span>children <span class="token operator">?</span> el<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> childs <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">,</span> len <span class="token operator">=</span> childrenLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">,</span> tiers <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> score <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parentScore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>getBoundingClientRect <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">&lt;</span> <span class="token constant">WH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      score <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">.5</span> <span class="token operator">*</span> tiers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> score<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>变化率部分核心计算逻辑是获取 DOM 变化最大时对应的时间，代码如下所示</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendMark<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
      <span class="token keyword">var</span> isCheckFmp <span class="token operator">=</span> time <span class="token operator">&gt;</span> <span class="token number">30000</span> <span class="token operator">||</span> <span class="token constant">SCORE_ITEMS</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> time <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">[</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">CHECK_INTERVAL</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">[</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">===</span> <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">[</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>observer <span class="token operator">&amp;&amp;</span> isCheckFmp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span><span class="token constant">SCORE_ITEMS_CHART</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> fmps <span class="token operator">=</span> <span class="token function">getFmp</span><span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> fmps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t <span class="token operator">&gt;=</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> l <span class="token operator">=</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">-</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">!</span>record <span class="token operator">||</span> record<span class="token punctuation">.</span>rate <span class="token operator">&lt;=</span> l<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>record <span class="token operator">=</span> <span class="token punctuation">{</span>
              t<span class="token operator">:</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">,</span>
              rate<span class="token operator">:</span> l
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fmp <span class="token operator">=</span> record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>t <span class="token operator">||</span> <span class="token number">30001</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkImgs</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
          <span class="token keyword">let</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>imgs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\/\/)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> element <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> element<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>responseEnd <span class="token operator">||</span> <span class="token number">0</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>t <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>t <span class="token operator">&lt;</span> <span class="token number">36e5</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPerformance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            fmpImg<span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>t <span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPerformance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPerformance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// console.error(error)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">CHECK_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个就是首屏计算的部分流程。</p> <p>看完前面的流程，不知道你有没有这样的疑问：<code>如果页面里包含图片，使用上面的首屏指标采集方案，结果准确吗</code>？</p> <blockquote><p>结论是：不准确。上述计算逻辑主要是针对 DOM元素来做的，图片加载过程是异步，图片容器（图片的 DOM 元素）和内容的加载是分开的，当容器加载出来时，内容还没出来，一定要确保内容加载出来，才算首屏。</p></blockquote> <p>这就需要增加一些策略了，以下是包含图片页面的首屏计算 demo。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>imgTest<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://www.baidu.com/img/bd_logo1.png?where=super<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>imgTest<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://www.baidu.com/img/bd_logo1.png?where=super<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>text/css</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token property">background-image</span><span class="token punctuation">:</span><span class="token function">url</span><span class="token punctuation">(</span>'<span class="token property">https</span><span class="token punctuation">:</span>//www.baidu.com/img/dong_8f1d47bcb77d74a1e029d8cbb3b33854.gif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> getImageDomSrc <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">_getImgSrcFromBgImg</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">bgImg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> imgSrc<span class="token punctuation">;</span>
      <span class="token keyword">var</span> matches <span class="token operator">=</span> bgImg<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">url\(.*?\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>matches <span class="token operator">&amp;&amp;</span> matches<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> urlStr <span class="token operator">=</span> matches<span class="token punctuation">[</span>matches<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> innerUrl <span class="token operator">=</span> urlStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^url\([\'\&quot;]?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\'\&quot;]?\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>innerUrl<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>innerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          imgSrc <span class="token operator">=</span> innerUrl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> imgSrc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getImgSrcFromDom</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> imgFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>getBoundingClientRect <span class="token operator">&amp;&amp;</span> dom<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      imgFilter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\.)(png|jpg|jpeg|gif|webp|ico|bmp|tiff|svg)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">]</span>
      <span class="token keyword">var</span> src<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        src <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> computedStyle <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> bgImg <span class="token operator">=</span> computedStyle<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">'background-image'</span><span class="token punctuation">)</span> <span class="token operator">||</span> computedStyle<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">'background'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tempSrc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getImgSrcFromBgImg</span><span class="token punctuation">(</span>bgImg<span class="token punctuation">,</span> imgFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tempSrc <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isImg</span><span class="token punctuation">(</span>tempSrc<span class="token punctuation">,</span> imgFilter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          src <span class="token operator">=</span> tempSrc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">_isImg</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> imgFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> imgFilter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgFilter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token punctuation">,</span> tName <span class="token operator">=</span> e<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;SCRIPT&quot;</span> <span class="token operator">!==</span> tName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;STYLE&quot;</span> <span class="token operator">!==</span> tName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;META&quot;</span> <span class="token operator">!==</span> tName <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">!==</span> tName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImgSrcFromDom</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>imgs<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span>
          imgs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token keyword">var</span> len <span class="token operator">=</span> e<span class="token punctuation">.</span>children <span class="token operator">?</span> e<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> child <span class="token operator">=</span> e<span class="token punctuation">.</span>children<span class="token punctuation">,</span> _len <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> _len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> _len<span class="token operator">--</span><span class="token punctuation">)</span>
            _this<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>child<span class="token punctuation">[</span>_len<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  getImageDomSrc<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>imgs<span class="token punctuation">,</span><span class="token string">'-imgs--'</span><span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>imgs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\/\/)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span>
      element <span class="token operator">=</span> <span class="token string">'https:'</span> <span class="token operator">+</span> element<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>responseEnd <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>它的计算逻辑是这样的。</p> <p>首先，获取页面所有的图片路径。在这里，图片类型分两种，一种是带 IMG 标签的，一种是带 DIV 标签的。前者可以直接通过 src 值得到图片路径，后者可以使用 <code>window.getComputedStyle(dom)</code> 方式获取它的样式集合。</p> <p>接下来，通过正则获取图片的路径即可。</p> <p>然后通过 <code>performance.getEntriesByName(element)[0].responseEnd</code> 的方式获取到对应图片路径的下载时间，最后与使用 <code>MutationObserver</code> 获得的 DOM 首屏时间相比较，哪个更长，哪个就是最终的首屏时间。</p> <blockquote><p>以上就是首屏采集的完整流程</p></blockquote> <blockquote><p>注意：计算首屏时间用到的<code>getBoundingClientRect</code>和<code>getComputedStyle</code>会引起强制回流</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503151137.png" loading="lazy" class="lazy"></p> <h2 id="三、指标采集-白屏、卡顿、网络环境指标采集方法"><a href="#三、指标采集-白屏、卡顿、网络环境指标采集方法" class="header-anchor">#</a> 三、指标采集：白屏、卡顿、网络环境指标采集方法</h2> <h3 id="白屏指标采集"><a href="#白屏指标采集" class="header-anchor">#</a> 白屏指标采集</h3> <blockquote><p>白屏时间是指从输入内容回车（包括刷新、跳转等方式）后，到页面开始出现第一个字符的时间。白屏时间的长短会影响用户对 App 或站点的第一印象</p></blockquote> <p>白屏指标怎么采集呢？我们先来回顾一下浏览器的页面加载过程：</p> <blockquote><p>客户端发起请求 -&gt; 下载 HTML 及 JS/CSS 资源 -&gt; 解析 JS 执行 -&gt; JS 请求数据 -&gt; 客户端解析 DOM 并渲染 -&gt; 下载渲染图片-&gt; 完成渲整体染</p></blockquote> <p>在这个过程中，客户端解析 DOM 并渲染之前的时间，都算白屏时间。所以，<strong>白屏时间的采集思路如下</strong>：<code>白屏时间 = 页面开始展示时间点 - 开始请求时间点</code>。如果你是借助浏览器的 <code>Performance API</code> 工具来采集，那么可以使用公式：<code>白屏时间 FP</code> = <code>domLoading - navigationStart</code>。</p> <p>这是浏览器页面加载过程，如果放在 App场景下，就不太一样了，App下的页面加载过程：</p> <blockquote><p>初始化 WebView -&gt; 客户端发起请求 -&gt; 下载 HTML 及 JS/CSS 资源 -&gt; 解析 JS 执行 -&gt; JS 请求数据 -&gt; 服务端处理并返回数据 -&gt; 客户端解析 DOM 并渲染 -&gt; 下载渲染图片 -&gt; 完成整体渲染。</p></blockquote> <p><code>App下的白屏时间，多了启动浏览器内核，也就是 Webview 初始化的时间</code>。这个时间必须通过手动采集的方式来获得，而且因为线上线下时间差别不大，线下采集即可。<strong>具体来说，在 App 测试版本中，程序在 App 创建 WebView 时打一个点，然后在开始建立网络连接打一个点，这两个点的时间差就是 Webview 初始化的时间</strong>。</p> <h3 id="卡顿指标采集"><a href="#卡顿指标采集" class="header-anchor">#</a> 卡顿指标采集</h3> <p><strong>所谓卡顿，简单来说就是页面出现卡住了的不流畅的情况</strong>。 提到它的指标，你是不是会一下就想到 FPS（Frames Per Second，每秒显示帧数）？FPS 多少算卡顿？网上有很多资料，大多提到 FPS 在 60 以上，页面流畅，不卡顿。但事实上并非如此，比如我们看电影或者动画时，素虽然 FPS 是 30 （低于60），但我们觉得很流畅，并不卡顿。</p> <p>FPS 低于 60 并不意味着卡顿，那 FPS 高于 60 是否意味着一定不卡顿呢？比如前 60 帧渲染很快（10ms 渲染 1 帧），后面的 3 帧渲染很慢（ 20ms 渲染 1 帧），这样平均起来 FPS 为95，高于 60 的标准。这种情况会不会卡顿呢？实际效果是卡顿的。因为卡顿与否的关键点在于单帧渲染耗时是否过长。</p> <blockquote><p>但难点在于，在浏览器上，我们没办法拿到单帧渲染耗时的接口，所以这时候，只能拿 FPS 来计算，只要 FPS 保持稳定，且值比较低，就没问题。<code>它的标准是多少呢？连续 3 帧不低于 20 FPS，且保持恒定</code>。</p></blockquote> <p>以 H5 为例，<code>H5 场景下获取 FPS 方案如下</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">fps_compatibility</span><span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">||</span>
        window<span class="token punctuation">.</span>webkitRequestAnimationFrame <span class="token operator">||</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fps_config<span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token literal-property property">lastTime</span><span class="token operator">:</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastFameTime</span> <span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">frame</span><span class="token operator">:</span><span class="token number">0</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token function-variable function">fps_loop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _first <span class="token operator">=</span>  performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>_diff <span class="token operator">=</span> <span class="token punctuation">(</span>_first <span class="token operator">-</span> fps_config<span class="token punctuation">.</span>lastFameTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fps_config<span class="token punctuation">.</span>lastFameTime <span class="token operator">=</span> _first<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fps <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">/</span>_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fps_config<span class="token punctuation">.</span>frame<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_first <span class="token operator">&gt;</span> <span class="token number">1000</span> <span class="token operator">+</span> fps_config<span class="token punctuation">.</span>lastTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> fps <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> fps_config<span class="token punctuation">.</span>frame <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> _first <span class="token operator">-</span> fps_config<span class="token punctuation">.</span>lastTime <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">time: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> fps is：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> fps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fps_config<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
        fps_config<span class="token punctuation">.</span>lastTime <span class="token operator">=</span> _first <span class="token punctuation">;</span>    
    <span class="token punctuation">}</span><span class="token punctuation">;</span>           
    <span class="token function">fps_compatibility</span><span class="token punctuation">(</span>fps_loop<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
<span class="token function">fps_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token parameter">fpsList<span class="token punctuation">,</span> below<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> last<span class="token operator">=</span><span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fpsList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> below<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>利用 <code>requestAnimationFrame</code> 在一秒内执行 <code>60</code> 次（在不卡顿的情况下）这一点，假设页面加载用时 <code>X ms</code>，这期间 <code>requestAnimationFrame</code> 执行了 <code>N</code> 次，则帧率为 <code>1000* N/X</code>，也就是<code>FPS</code></p></blockquote> <p>由于用户客户端差异很大，我们要考虑兼容性，在这里我们定义 <code>fps_compatibility</code> 表示兼容性方面的处理，在浏览器不支持 <code>requestAnimationFrame</code> 时，利用 <code>setTimeout</code> 来模拟实现，在 <code>fps_loop</code> 里面完成 FPS 的计算，最终通过遍历 <code>fpsList</code> 来判断是否连续三次 fps 小于20。</p> <p>如果连续判断 3次 FPS 都小于20，就认为是卡顿。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503152718.png" loading="lazy" class="lazy"></p> <h2 id="四、工具实践-性能-sdk-及上报策略设计"><a href="#四、工具实践-性能-sdk-及上报策略设计" class="header-anchor">#</a> 四、工具实践：性能 SDK 及上报策略设计</h2> <p>由于性能 SDK 最终是给各个业务使用的，所以它的设计要满足在接入性能监控平台时，简单易用和运行平稳高效，这两个要求。</p> <h3 id="sdk-接入设计"><a href="#sdk-接入设计" class="header-anchor">#</a> SDK 接入设计</h3> <p>要保证 <code>SDK</code> 接入简单，容易使用，<code>首先要把之前首屏、白屏和卡顿采集的脚本封装在一起，并让脚本自动初始化和运行</code>。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503152937.png" loading="lazy" class="lazy"></p> <ul><li>具体来说，首屏采集的<code>分数计算部分 API（calculateScore）</code>、<code>变化率计算的 API（calFinallScore）</code>和<code>首屏图片时间计算 API（fmpImg）</code>可以一起封装成 FMP API。其中首屏图片计算 API 因为比较独立，可以专门抽离成一个 util，供其他地方调用。白屏和卡顿采集也类似，可以封装成 <code>FP API</code> 和 <code>BLOCK API</code>。</li> <li>还有一个 <code>ExtensionAPI</code> 接口，用来封装一些后续需要使用的数据，比如加载瀑布流相关的数据（将首屏时间细分为DNS、TCP连接等时间），这些数据可以通过浏览器提供的 <code>performance</code> 接口获得。</li></ul> <blockquote><p>为了进行首屏、白屏、卡顿的指标采集，我们可以封装 <code>Perf API</code>，调用 <code>FMP、FP、BLOCK、ExtensionAPI</code> 四个 API 来完成。因为是调用 <code>window.performance</code> 接口，所以先做环境兼容性的判断，即看看浏览器是否支持 <code>window.performance</code></p></blockquote> <p>最终我们接入时只要安装一个 <code>npm</code> 包，然后初始化即可，具体代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code> npm install @common<span class="token operator">/</span>Perf <span class="token operator">-</span><span class="token constant">S</span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token punctuation">{</span> perfInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@common'</span><span class="token punctuation">;</span>
 <span class="token function">perfInit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者以外链的形式接入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>s1<span class="token punctuation">.</span>static<span class="token punctuation">.</span>com<span class="token operator">/</span>common<span class="token operator">/</span>perf<span class="token operator">/</span><span class="token keyword">static</span><span class="token operator">/</span>js<span class="token operator">/</span><span class="token number">1.0</span><span class="token number">.0</span><span class="token operator">/</span>perf<span class="token punctuation">.</span>min<span class="token punctuation">.</span>js<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">perfInit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了性能 SDK 自身的方案设计之外，提供帮助文档（如示例代码、 QA 列表等），也可以提高性能 SDK 的易用性。</p> <p>具体来说，我们可以搭建一个简单的性能 SDK 网站，进入站点后，前端工程师可以看到使用文档，包括各种平台下如何接入，接入的示例代码是怎样的，接入性能 SDK 后去哪个 URL 看数据，遇到异常问题时怎么调试，等等。</p> <h3 id="sdk-运行设计"><a href="#sdk-运行设计" class="header-anchor">#</a> SDK 运行设计</h3> <p>SDK 如果想运行高效，必须有好的兼容性策略、容错机制和测试方案。</p> <p>所谓兼容性策略，就是性能 SDK 可以在各个业务下都可以稳定运行。</p> <p><strong>我们知道，前端性能优化会面临的业务场景大致有：</strong></p> <ul><li>各类页面，如平台型页面、3C 类页面、中后台页面；</li> <li>一些可视化搭建的平台，如用于搭建天猫双十一会场页这种用于交易运行页面的魔方系统；</li> <li>各个终端，如 PC 端，移动端，小程序端等。</li></ul> <p>这就要求性能 SDK 要能适应这些业务，及时采集性能指标并进行上报。那具体怎么做呢？</p> <p>一般不同页面和终端，它们的技术栈也会不同，如 PC端页面使用 React，移动端页面使用 VUE 。这个时候，<code>我们可以尽可能用原生 JavaScript 去做性能指标的采集，从而实现跨不同技术栈的采集</code>。</p> <blockquote><p>不同终端方面，我设计了一个适配层来抹平采集方面的差异。<code>具体来说，小程序端可以用有自己的采集 API，如 minaFMP</code>，<code>其他端可以直接用 FMP</code>，这样在性能 SDK 初始化时，<code>根据当前终端类型的不同，去调用各自的性能指标采集 API</code>。</p></blockquote> <p>容错方面怎么做呢？</p> <blockquote><p>如果是性能 SDK 自身的报错，可以通过 <code>try catch</code> 的方式捕获到，然后上报异常监控平台。注意，不要因为 SDK 的报错而影响引入性能 SDK 页面的正常运行。</p></blockquote> <h3 id="日志数据过滤"><a href="#日志数据过滤" class="header-anchor">#</a> 日志数据过滤</h3> <p>我的建议是，在采集性能指标之后，最好先对异常数据进行过滤。</p> <p>异常数据分一般有两类，第一类是计算错误导致的异常数据，比如负值或者非数值数据，第二类是合法异常值、极大值、极小值，属于网络断掉或者超时形成的数值，比如 15s 以上的首屏时间。</p> <p>负值的性能指标数据影响很大，它会严重拖低首屏时间，也会把计算逻辑导致负值的问题给掩盖掉。</p> <h3 id="数据抽样策略"><a href="#数据抽样策略" class="header-anchor">#</a> 数据抽样策略</h3> <p>性能 SDK 上报数据是全量还是抽象，需要根据本身 App 或者网站的日活来确定，如果日活10万以下，那抽样就没必要了。如果是一款日活千万的 App，那就需要进行数据抽样了，因为如果上报全量日志的话，会耗费大量用户的流量和请求带宽。</p> <h3 id="上报机制选择"><a href="#上报机制选择" class="header-anchor">#</a> 上报机制选择</h3> <p>一般，为了节省流量，性能 SDK 也会根据网络能力，选择合适的上报机制。在强网环境（如 <code>4G/WIFI</code>），直接进行上报；在弱网（<code>2G/3G</code>）下，将日志存储到本地，延时到强网下再上报。</p> <p>除了网络能力，我们还可以让 SDK 根据 App 忙碌状态，选择合适的上报策略。如果 App 处于空闲状态，直接上报；如果处于忙碌状态，等到闲时（比如凌晨 2-3 点）再进行上报。</p> <p>除此之外，还有一些其他的策略，如批量数据上报，默认消息数量达到 30 条才上报，或者只在 App 启动时上报等策略，等等。你可以根据实际情况进行选择。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503153920.png" loading="lazy" class="lazy"></p> <blockquote><p>采集到数据后，先对数据进行校验，如果发现数据异常则直接上报到数据异常平台（通过邮件或者钉钉通知的方式发送给开发者），反之如果数据是正常范围内的，则结合采样率来看是否需要上报。</p></blockquote> <h2 id="五、平台实践-如何从-0-到-1-搭建前端性能平台"><a href="#五、平台实践-如何从-0-到-1-搭建前端性能平台" class="header-anchor">#</a> 五、平台实践：如何从 0 到 1 搭建前端性能平台</h2> <p>前端性能平台是一个 Web 系统，主要包括后台的性能数据处理和前台的可视化展示两部分</p> <p>其中，数据处理后台主要是对 SDK 上报后的性能指标进行处理和运算，具体包括数据入库、数据清洗、数据计算，做完这些后，前台会对结果进行可视化展现，我们借助它就可以实时监督前端的性能情况。下图是性能平台大盘页的效果，主要对当前用户关注的性能模块进行展示，内容包括首屏时间、秒开率和采样PV。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503154327.png" loading="lazy" class="lazy"></p> <p>那么，我们该如何搭建这样一个性能平台呢？</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503154342.png" loading="lazy" class="lazy"></p> <p><strong>这是具体的技术架构图，从底层到前台大致情况如下：</strong></p> <ul><li>数据接入层，主要是接收 <code>SDK</code> 上报的性能数据，做数据处理后入库，包含的技术有 <code>Node.js、Node-sechdule、Node-mailer</code>；</li> <li>数据计算层，会对性能数据做计算处理，需要的技术有 <code>Kafka、Spark、Hive、HDFS</code></li> <li>存储层，包括 <code>MySQL + MongoDB</code> ，性能平台需要的数据会来这里</li> <li>平台层，也就是展示给用户的部分，需要的技术有 <code>React、Ant design、Antv、Less</code></li></ul> <h3 id="性能数据处理后台"><a href="#性能数据处理后台" class="header-anchor">#</a> 性能数据处理后台</h3> <p>想要搭建性能平台，我们先来看它的性能处理后台情况。<strong>一般性能 SDK 上报数据的处理过程是这样的</strong>：</p> <ul><li>客户端借助 <code>SDK</code> 上报性能数据指标，数据接入层（图中绿色部分）接收相应数据，并做协议转换等简单处理后，作为生产者向 Kafka 写入数据；</li> <li>数据计算层（图中橙色部分）作为消费者，从 Kafka 读数据存入 Hive（Hadoop平台的存储表），Hadoop 平台借助 Spark 做数据分析计算；</li> <li>借助 Hive 提供的接口，数据计算层使用 SQL 语句从 Hive 拉取计算后的数据到数据库平台（MongoDB），平台层取出数据，准备数据可视化展现的数据。</li></ul> <p><strong>上述数据流程，对应的性能数据后台的搭建过程如下</strong>：</p> <ol><li>第一步是入库，客户端借助 SDK 上报性能数据指标后，需要后端服务层的处理，这里我们选取的是 NodeJS 做后端，利用 Controller 层对数据做处理。</li></ol> <p>为了避免数据库出现“脏数据”（如空数据、异常数据），影响后续数据处理，我们将 SDK 上报的数据通过 URL 解析成 key-value 格式的数据，对数据进行空数据删除，异常数据舍弃等操作。然后我们让数据写进消息队列 Kafka。</p> <p><strong>为什么不是直接存入 Hive 呢？</strong></p> <p>因为客户端上报的性能数据量和用户规模有关。如果直接入库到 Hive，遇到高并发的时候，会因为服务器扛不住而导致数据丢失。与此同时，因为数据下游（数据的使用方，如数据清洗计算平台，性能预警模块）会有多个数据接收端，直接入库的话也会造成数据重复。</p> <p>所以最好我们选择 Kafka，先让数据写进消息队列。Kafka 能通过缓存，慢慢接收这些数据，降低流量洪峰压力。同时，消息队列还有接收数据后将其删除的特点，可以避免数据重复的问题。</p> <ol start="2"><li>第二步，<code>对 Kafka 中的数据，做数据清洗和数据计算</code></li></ol> <p><strong>数据清洗，是指针对性能上报单条数据进行核对校验的过程。所清洗的数据包括：</strong></p> <ul><li>对重复数据的处理，即同一个用户网络出错时，多次重试导致上传了好几条首屏时间相关的数据；</li> <li>对缺失数据的处理，虽然上报了首屏时间，但白屏时间或者卡顿时间计算时没能给出；</li> <li>对错误数据的处理，即数据超出正常范围，出现负值或者超出极大值的情况。</li></ul> <p>这几种类型数据问题如果不处理，最终会影响计算结果的准确性。那么该怎么处理呢？</p> <ul><li>遇到重复数据，直接去重删除即可。</li> <li>遇到缺失数据，我们在 Spark 平台上，先根据上报的 Performance 数据进行计算补全，如果无法补全的，就直接舍弃掉，不然会出现后续无法入库的情况。</li> <li>遇到超出正常范围的数据，如负值或者超过 10 秒以上的数据，把它当作无效数据，直接舍弃掉。</li></ul> <blockquote><p>做完数据清洗之后，我们还需要<code>使用 Spark 做数据计算，为可视化展现准备数据</code>。具体需要做以下数据计算：</p></blockquote> <ul><li>首屏时间分布的计算，<code>1s ～ 2s</code> 占比多少，<code>2s ～ 4s</code> 占比多少；</li> <li>秒开率的计算，首屏时间小于等于 1 秒的数据占比；</li> <li>页面瀑布流时间的计算。</li></ul> <p>其中，页面瀑布流时间是对首屏时间的细分，<code>包括 DNS 查询、TCP链接、请求耗时、内容传输、资源解析、DOM 解析和资源加载的时间</code>。这些细分时间点，是我们根据 SDK 上报的 Performance 接口数据指标计算出来的，前端工程师根据页面瀑布流时间，可以快速定位性能瓶颈点出现在哪个环节。</p> <ol start="3"><li>第三步，准备性能前台所需的可视化数据</li></ol> <p>为了完成前台展现，性能平台需要登录功能，还需要做一些用户关注的模块信息，比如前端开发者添加关注的业务模块。我们可以用关系数据库去存储这些数据，具体可以选择 MySQL完成账号权限系统和关注业务模块对应的数据表。</p> <p>而性能数据，因为都是单条性能信息，相互之间并没有什么关系，可以用 MongoDB 做存储。具体来说，我们可以用 NodeJS 提供的定时脚本（Node-sechdule）从 Spark 取到数据导入到 MongoDB 中。</p> <h3 id="前端数据可视化展示前台"><a href="#前端数据可视化展示前台" class="header-anchor">#</a> 前端数据可视化展示前台</h3> <p>前端数据可视化展现前台，整体上只有两个页面，大盘页和详情页。</p> <p>大盘页包括一个个业务的性能简图。每一个性能简图包括首屏时间、秒开率、采样 PV 数据。点击性能简图上的“进入详情”链接，就可以进入详情页。初次进入大盘页的时候，需要你登录并关注相关的业务，然后就可以在大盘首页看到相关的性能情况。</p> <p>详情页的设计的初衷是为了对性能简图做进一步的补充，除了展示对应性能简图的秒开率、性能均值细节、白屏均值细节之外，还会展示终端信息，比如多少比例在IOS端，多少比例在Android端，以方便用户根据不同场景去做优化。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503160942.png" loading="lazy" class="lazy"></p> <blockquote><p>同时，为了解秒开率不达标原因或者首屏时间变慢的细节在哪里，我们会给出页面加载瀑布流，前面数据处理阶段已经提到可以使用的数据（包括 DNS 查询、TCP链接、请求耗时、内容传输、资源解析、DOM 解析和资源加载的时间），套用 AntV （阿里巴巴集团的数据可视化方案）的瀑布流模板即可完成数据展现。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503161021.png" loading="lazy" class="lazy"></p> <p><strong>那么，大盘页和详情页如何实现的呢？</strong></p> <p>首先是前端展示技术栈的选择，对应技术架构图中的淡黄色部分，因为这两个页面都属于 PC 端后台页面，主要给公司前端开发者使用，功能上更多是数据可视化展示，非常适合用 React 技术栈做开发。</p> <p>为了更好实现首屏时间、秒开率和采用 PV 的功能效果，我们使用 AntdPro 的模板，相关的配套的数据可视化方案，我推荐 Antv，因为它能够满足我们在首屏时间、秒开率等性能指标的展示需求，用起来比较简单（开箱即用），功能灵活且扩展性强（比如秒开率部分，要自定义一些图形，能够较好满足）。</p> <p>大盘页和详情页的数据展示效果比较丰富多样，相应的 CSS 代码逻辑就比较复杂，为了让 CSS代码更容易维护和扩展，CSS 方面可以选用 Less 框架。</p> <p>接下来是前后端交互方面，为了让前后台更独立，大盘页、详情页与后端的通信通过 HTTP 接口来实现，使用 nginx 作为 Web Server。为了让传输更高效，我们采用 compression 对 HTTP 传输内容进行 GZip 压缩处理。</p> <p>最后是后台服务部分，为了让性能平台开发过程更简单，效率更高，同时平台本身的性能体验更流畅，后台服务方面可以选用 Egg.js（基于 NodeJS 的开发框架）做开发，进行数据处理和存储服务。</p> <p>为了解决监控预警的问题，我们借助 <code>Node-schedule</code> 做调度和定时任务的处理，通过 <code>node-mailer</code> 进行邮件报警</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503161251.png" loading="lazy" class="lazy"></p> <h2 id="六、诊断清单-如何实现监控预警并进行问题诊断"><a href="#六、诊断清单-如何实现监控预警并进行问题诊断" class="header-anchor">#</a> 六、诊断清单：如何实现监控预警并进行问题诊断</h2> <h3 id="监控预警"><a href="#监控预警" class="header-anchor">#</a> 监控预警</h3> <p>监控预警部分，我们借助 Node-schedule 做调度和定时任务的处理，通过 node-mailer 进行邮件报警。具体来说我们通过以下几步来实现。</p> <p><strong>第一步，准备预警数据</strong></p> <p>在做完数据清洗之后，一个分支使用 <code>Spark</code> 做计算，另外一个分支使用 <code>Flink</code> 实时数据计算。这两者的区别在于后者的数据是实时处理的，因为监控预警如果不实时的话，就没有意义了。有关数据的处理，我是这样做的：超过 2s 的数据，或者认定为卡顿的数据，直接标记为预警数据。实际当中你也可以根据情况去定义和处理。</p> <p><strong>第二步，我们借助 Node-schedule</strong>，用一批定时任务将预警数据通过 Node.js，拉取数据到 MongoDB 的预警表中。</p> <p><strong>第三步，预警的展示流程</strong>。根据预警方式不同，样式展示也不同。具体来说，预警的方式有三种：企业微信报警通知、邮件报警通知、短信报警通知。</p> <p>以手机列表页为例，性能标准是首屏时间 1.5s，秒开率 90%，超过这个标准就会在性能平台预警模块展示，按照严重程度倒序排列展示。如果超出 10%，平台上会标红展示，并会发企业微信报警通知；如果超过 20%，会发借助 <code>node-mailer</code> 做邮件报警；如果超出 30%，会发短信报警通知。</p> <p>注意，预警通知需要用到通信资源，为了避免数据量太大而浪费资源，一般对 App 首页核心的导航位进行页面监控即可。</p> <h3 id="问题诊断"><a href="#问题诊断" class="header-anchor">#</a> 问题诊断</h3> <p>当预警功能做好后，前端性能平台就可以对重要指标进行实时监督了。当发现性能问题——不论是我们自己发现还是用户反馈，都需要先对问题进行诊断，然后看情况是否需要进一步采取措施。</p> <p>一般问题诊断时需要先确认是共性问题还是个例问题。如果是共性问题，那接下来我们就开始诊断和优化；如果是个例问题，是因为偶发性因素导致的（如个人的网络抖动、手机内存占用太多、用户连了代理等），则不需要进行专门优化。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503161715.png" loading="lazy" class="lazy"></p> <h2 id="七、优化手段-首屏秒开的-4-重保障"><a href="#七、优化手段-首屏秒开的-4-重保障" class="header-anchor">#</a> 七、优化手段：首屏秒开的 4 重保障</h2> <h3 id="懒加载"><a href="#懒加载" class="header-anchor">#</a> 懒加载</h3> <p>懒加载是性能优化的前头兵。什么叫懒加载呢？懒加载是指在长页面加载过程时，先加载关键内容，延迟加载非关键内容。比如当我们打开一个页面，它的内容超过了浏览器的可视窗口大小，我们可以先加载前端的可视区域内容，剩下的内容等它进入可视区域后再按需加载。</p> <p>具体怎么做呢？我们可以先根据手机的可视窗口，估算需要多少条数据，比如京东 App 列表页是 4 条数据，这时候，先从后端拉取 4 条数据进行展现，然后超出首屏的内容，可以在页面下拉或者滚动时再发起加载。</p> <p>那么如果首页当中图片比较多，比如搜索引擎产品的首页，如何保证首屏秒开呢？同样也可以采用懒加载。以百度图片列表页为例，可视区域范围内的图片先请求加载，一般会根据不同手机机型估算一个最大数据，比如 ihone12 Pro 屏幕比较大， 4 行 8 条数据，我们就先请求 8 条数据，用来在可视区域展示，其他位置采用占位符填充，在滑动到目标区域位置后，才使用真实的图片填充。这样，通过使用懒加载，可以最大限度降低了数据接口传输阶段的时间。</p> <h3 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h3> <p>如果说懒加载本质是提供首屏后请求非关键内容的能力，那么缓存则是赋予二次访问不需要重复请求的能力。在首屏优化方案中，接口缓存和静态资源缓存起到中流砥柱的作用。</p> <h3 id="接口缓存"><a href="#接口缓存" class="header-anchor">#</a> 接口缓存</h3> <p>接口缓存的实现，如果是端内的话，所有请求都走 Native 请求，以此来实现接口缓存。为什么要这么做呢？</p> <p>App 中的页面展现有两种形式，使用 Native 开发的页面展现和使用 H5 开发的页面展现。如果统一使用 Native 做请求的话，已经请求过的数据接口，就不用请求了。而如果使用 H5 请求数据，必须等 WebView 初始化之后才能请求（也就是串行请求），而 Native 请求时，可以在 WebView 初始化之前就开始请求数据（也就是并行请求），这样能有效节省时间。</p> <p>那么，如何通过 Native 进行接口缓存呢？**我们可以借助 SDK 封装来实现，即修改原来的数据接口请求方法，实现类似 Axios 的请求方法。**具体来说就是，把包括 post、Get 和 Request 功能的接口，封装进 SDK 中。</p> <p>这样，客户端发起请求时，程序会调用 SDK.axios 方法，WebView 会拦截这个请求，去查看 App 本地是否有数据缓存，如果有的话，就走接口缓存，如果没有的话，先向服务端请求数据接口，获取接口数据后存放到 App 缓存中。</p> <h3 id="静态资源缓存"><a href="#静态资源缓存" class="header-anchor">#</a> 静态资源缓存</h3> <p>数据接口的请求一般来说较少，只有几个，而静态资源（如 JS、CSS、图片和字体等）的请求就太多了。以京东首页为例，177 个请求中除了 1 个文档和 1 个数据接口外，其余都是静态资源请求。</p> <p>那么，如何做静态缓存方案呢？这里有两种情况，一种是静态资源长期不需要修改，还有一种是静态资源修改频繁的</p> <p>资源长期不变的话，比如 1 年都不怎么变化，我们可以使用强缓存，如 Cache-Control 来实现。具体来说可以通过设置 Cache-Control:max-age=31536000，来让浏览器在一年内直接使用本地缓存文件，而不是向服务端发出请求。</p> <p>至于第二种，<strong>如果资源本身随时会发生改动的，可以通过设置 Etag 实现协商缓存</strong> 具体来说，在初次请求资源时，设置 Etag（比如使用资源的 md5 作为 Etag），并且返回 200 的状态码，之后请求时带上 <code>If-none-match</code> 字段，来询问服务器当前版本是否可用。如果服务端数据没有变化，会返回一个 304 的状态码给客户端，告诉客户端不需要请求数据，直接使用之前缓存的数据即可</p> <h3 id="离线化"><a href="#离线化" class="header-anchor">#</a> 离线化</h3> <p>离线化是指线上实时变动的资源数据静态化到本地，访问时走的是本地文件的方案。说到这里，你是不是想到了离线包？离线包是离线化的一种方案，是将静态资源存储到 App 本地的方案，不过，在这里，我重点讲的是离线化的另一个方案——把页面内容静态化到本地。</p> <p>离线化一般适合首页或者列表页等不需要登录页面的场景，同时能够支持 SEO 功能。那么，如何实现离线化呢？其实，打包构建时预渲染页面，前端请求落到 index.html 上时，已经是渲染过的内容。此时，可以通过 Webpack 的 <code>prerender-spa-plugin</code>来实现预渲染，进而实现离线化。Webpack 实现预渲染的代码示例如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.conf.js</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> PrerenderSpaPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prerender-spa-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">PrerenderSpaPlugin</span><span class="token punctuation">(</span>
      <span class="token comment">// 编译后的html需要存放的路径</span>
      path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 列出哪些路由需要预渲染</span>
      <span class="token punctuation">[</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'/about'</span><span class="token punctuation">,</span> <span class="token string">'/contact'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="并行化"><a href="#并行化" class="header-anchor">#</a> 并行化</h3> <p>懒加载、缓存和离线化都是在请求本身上下功夫，想尽办法减少请求或者推迟请求，并行化则是在请求通道上功夫，解决请求阻塞问题，进而减少首屏时间。 这就像解决交通阻塞一样，除了限号减少车辆，还可以增加车道数量，我们在处理请求阻塞时，也可以加大请求通道数量——借助于HTTP 2.0 的多路复用方案来解决。</p> <p>HTTP 1.1 时代，有两个性能瓶颈点，串行的文件传输和同域名的连接数限制（6个），到了HTTP 2.0 时代，因为提供了多路复用的功能，传输数据不再使用文本传输（文本传输必须按顺序传输，否则接收端不知道字符的顺序），而是采用二进制数据帧和流的方式进行传输。</p> <p>其中，帧是数据接收的最小单位，流是连接中的一个虚拟通道，它可以承载双向信息。每个流都会有一个唯一的整数 ID 对数据顺序进行标识，这样接收端收到数据后，可以按照顺序对数据进行合并，不会出现顺序出错的情况。所以，在使用流的情况下，不论多少个资源请求，只要建立一个连接即可。</p> <p>文件传输环节问题解决后，同域名连接数限制问题怎么解决呢？以 Nginx 服务器为例，原先因为每个域名有 6 个连接数限制，最大并发就是 100 个请求，采用 HTTP 2.0 之后，现在则可以做到 600，提升了 6倍。</p> <p>你一定会问，这不是运维侧要做的事情吗，我们前端开发需要做什么？我们要改变静态文件合并（JS、CSS、图片文件）和静态资源服务器做域名散列这两种开发方式。</p> <p>具体来说，使用 HTTP 2.0 多路复用之后，单个文件可以单独上线，不需要再做 JS 文件合并了。因为原先遇到由 A 和 B 组成的 C 文件，其中 A 文件稍微有点修改，整个C 文件就需要重新加载的情况，如今由于没有同域名连接数限制了，也就不需要了。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503162414.png" loading="lazy" class="lazy"></p> <h2 id="八、优化手段-白屏-300ms-和界面流畅优化技巧"><a href="#八、优化手段-白屏-300ms-和界面流畅优化技巧" class="header-anchor">#</a> 八、优化手段：白屏 300ms 和界面流畅优化技巧</h2> <h3 id="白屏优化"><a href="#白屏优化" class="header-anchor">#</a> 白屏优化</h3> <p>现在我们假设一个场景，有一天你想要在某电商 App 上买个手机，于是你搜索后进入商品列表页，结果屏幕一片空白，过了好久还是没什么内容出现，这时候你是不是会退出来，换另外一个电商 App 呢？这就是白屏时间过长导致用户跳出的情形。</p> <p>作为前端开发者，我们遇到这种问题如何解决呢？首先去性能平台上查看白屏时间指标，确认是否是白屏问题。问题确认后，我们可以基于影响白屏时间长短的两个主要因素来解决——DNS 查询和首字符展示。</p> <h3 id="dns-查询优化"><a href="#dns-查询优化" class="header-anchor">#</a> DNS 查询优化</h3> <p>DNS 查询是指浏览器发起请求时，需要将用户输入的域名地址转换为 IP 地址的过程，这个转换时间长短就会影响页面的白屏时间。</p> <p>那么如何对 DNS 查询进行优化呢？根据 DNS 查询过程，我们可以从前端和客户端这两部分采取措施。</p> <p>前端侧，可以通过在页面中加入 <code>dns-prefetch</code>，在静态资源请求之前对域名进行解析，从而减少用户进入页面的等待时间。如下所示：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;meta http-equiv=&quot;x-dns-prefetch-control&quot; content=&quot;on&quot; /&gt;
&lt;link rel=&quot;dns-prefetch&quot; href=&quot;https://s.google.com/&quot; &gt;
</code></pre></div><p>其中第一行中的 <code>x-dns-prefetch-control</code> 表示开启 <code>DNS</code> 预解析功能，第二行 <code>dns-prefetch</code> 表示强制对 <code>s.google.com</code> 的域名做预解析。这样在 <code>s.google.com</code> 的资源请求开始前，<code>DNS</code> 解析完成，后续请求就不需要重复做解析了。不要小看这个标签哦，它可以为你减少 <code>150ms</code> 左右的 DNS 解析时间。</p> <p>客户端侧呢？可以在启动 App 时，同步创建一个肉眼不可见的 WebView（例如 1*1 像素的 webview），将常用的静态资源路径写入这个 WebView 中，然后对它做域名解析并放入缓存中。这样后面需要使用 WebView 打开真正所需的页面时，由于已经做过域名解析了，客户端直接从缓存中获取即可。</p> <p>当然如果是端外页面，因为没在 App 里面，就没法使用 <code>1*1 WebView</code> 的策略了，我们可以使用 <code>iframe</code> ，也能达到类似效果。</p> <p>以上是一个轻量级的方案，通过它可以将 DNS 解析时间控制在 <code>400ms</code> 以内（这个算是比较快的）。如果你想要将耗时进一步压缩，比如控制在 200ms，此时就需要一个重量级的方案了。具体来说，可以采用 IP 直连方式，原来是请求 <code>www.google.com</code>，现在我们通过调用 SDK 进行域名解析，拿到对应的 IP（如 6.6.6.6），然后直接请求这个 IP 地址拿到数据。</p> <p>当然，这个实现起来需要避过许多坑，比如，HTTPS 证书和配置文件。</p> <p><code>Https</code> 证书是指当客户端使用 IP 直连时，请求 URL 中的 host 会被替换成对应的 IP，所以在证书验证时，会出现 domain 不匹配的情况，导致 SSL/TLS 握手不成功。</p> <p>怎么解决呢？在非 SNI（Server Name Indication，表示单 IP多域名）的场景下，可以把证书验证环节独立出来 （如 Hook证书校验环节），然后将 IP 替换为原来的域名。在 SNI 场景下，可以定制 <code>SSLSocketFactory</code>，在 createSocket 时替换为 IP，并进行 SNI/HostNameVerify 配置。</p> <p>而配置文件方面，一般在域名只有两三个的情况时，我们可以用到它来做 IP 和域名的映射。但随着机房的扩大，每次扩机器都要升级配置文件，后续会非常麻烦。</p> <p>对此我们可以采用 httpDNS 来解决。这是因为 httpDNS 可以准确调度到对应区域的服务器 IP 地址给用户，同时还可以避免运行商 DNS 劫持。具体来说， SDK 会通过发报文（类似系统向 DNS 运营商发的报文）向 httpDNS 做一个 HTTP 请求（也是通过 IP 直接请求），请求通过后拿到对应域名，然后进行 IP 直连，完成资源或者数据接口请求。</p> <h3 id="首字符展示优化"><a href="#首字符展示优化" class="header-anchor">#</a> 首字符展示优化</h3> <p>所谓首字符展示，通常我们会在页面加载过程中出现一个 loading 图，用来告诉用户页面内容需要加载，请耐心等待。但这样一个 loading 图既无法让用户感受到页面加载到什么程度，也无法给用户视觉上一个焦点，让人们的注意力集中在上面。</p> <p>如何解决这个问题呢？我们可以使用骨架屏。骨架屏（Skeleton Screen）是指在页面数据加载完成前，先给用户展示出页面的大致结构（灰色占位图），告诉用户页面正在渐进式地加载中，然后在渲染出实际页面后，把这个结构替换掉。骨架屏并没有真正减少白屏时间，但是给了用户一个心理预期，让他可以感受到页面上大致有什么内容。</p> <p>那么，如何构建骨架屏呢？因为考虑到每次视觉修改或者功能迭代，骨架屏都要配合修改，我建议采用自动化方案，而不是手动骨架屏方案（也就是自己编写骨架屏代码）。骨架屏的实现方法有以下三个步骤。</p> <ul><li>步骤一，确定生成规则，遍历所有的 DOM 元素。针对特定区块（如视频、音频）生成相应的代码块，获取原始页面中 DOM 节点的宽度、高度和距离视窗的位置，计算出当前设备快高对应的大小，转换成相应的百分比，然后来适配不同的设备。</li> <li>步骤二，基于上述规则结合 CLI 工具可以通过脚手架自动生成骨架屏</li> <li>步骤三，将骨架屏自动化注入页面，再利用 Puppeteer 把骨架屏代码注入页面中自动运行。整个过程比较复杂，且有不少坑</li></ul> <p>以上就是白屏时间优化方面相关的内容，但即便首屏展示比较快，如果有卡顿的现象，用户操作也会很不流畅，那怎么解决这个问题呢。下面我们就讲聊聊卡顿治理。</p> <h3 id="卡顿治理"><a href="#卡顿治理" class="header-anchor">#</a> 卡顿治理</h3> <p>卡顿现象，一般可以通过用户反馈或性能平台来发现。比如我们接到用户说某页面比较卡，然后在性能平台上查看卡顿指标后，发现页面出现连续 5 帧超过 50ms ，这就属于严重卡顿。如何处理呢？</p> <p>首先也还是问题的定位，先通过 charles 等工具抓包看一下数据接口，如果是和数据相关的问题，找后端同事，或者用数据缓存的方式解决。如果问题出在前端，一般和以下两种情形有关：<code>浏览器的主线程与合成线程调度不合理，以及计算耗时操作</code>。</p> <h3 id="浏览器的主线程与合成线程调度不合理"><a href="#浏览器的主线程与合成线程调度不合理" class="header-anchor">#</a> 浏览器的主线程与合成线程调度不合理</h3> <p>比如，在某电商 App 页面点击抽奖活动时，遇到一个红包移动的效果，在红包位置变化时，页面展现时特别卡，这就是主线程和合成线程调度的问题。怎么解决呢？</p> <p>一般来说，主线程主要负责运行 JavaScript，计算 CSS 样式，元素布局，然后交给合成线程，合成线程主要负责绘制。当使用 height、width、margin、padding 等作为 transition 值时，会让主线程压力很大。此时我们可以使用 transform 来代替直接设置 margin 等操作。</p> <p>比如红包元素从 margin-left:-10px 渲染到 margin-left:0，主线程需要计算样式 margin-left:-9px，margin-left:-8px，一直到 margin-left:0，每一次主线程计算样式后，合成线程都需要绘制到 GPU 再渲染到屏幕上，来来回回需要进行 10 次主线程渲染，10 次合成线程渲染，这给浏览器造成很大压力，从而出现卡顿。</p> <p>如何解决呢？我们可以利用 transform 来做，比如 tranform:translate(-10px,0) 到 transform:translate(0,0)，主线程只需要进行一次tranform:translate(-10px,0) 到 transform:translate(0,0)，然后合成线程去一次将 -10px 转换到 0px。这样的话，总计 11 次计算，可以减少 9 步操作，假设一次 10ms，将减少 90ms。</p> <h3 id="计算耗时操作"><a href="#计算耗时操作" class="header-anchor">#</a> 计算耗时操作</h3> <p>除了主线程和合成线程调度不合理导致的卡顿，还有因为计算耗时过大导致的卡顿。遇到这类问题，一般有两种解法：空间换时间和时间换空间。</p> <p>空间换时间方面，比如你需要频繁增加删除很多 DOM 元素，这时候一定会很卡，在对 DOM 元素增删的过程中最好先在 DocumentFragment （DOM文档碎片）上操作，而不是直接在 DOM上操作。只在最后一步操作完成后，将所有 DocumentFragment 的变动更新到 DOM上，从而解决频繁更新 DOM 带来的卡顿问题。</p> <p>至于时间换空间，一般是通过将一个复杂的操作细分成一个队列，然后通过多次操作解决复杂操作的问题。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503163046.png" loading="lazy" class="lazy"></p> <h2 id="九、js-sdk-设计"><a href="#九、js-sdk-设计" class="header-anchor">#</a> 九、JS SDK 设计</h2> <p><img alt="" data-src="https://s.poetries.work/images/20210503170316.png" loading="lazy" class="lazy"></p> <h3 id="performance"><a href="#performance" class="header-anchor">#</a> Performance</h3> <p>网站的性能怎么样。不能单单是靠某种工具去检测，就能得出的结果。因为影响它的因素有很多（dns解析、网络、缓存...）</p> <blockquote><p><code>Performance</code>是一个做前端性能监控离不开的<code>API</code>，最好在页面完全加载完成之后再使用，因为很多值必须在页面完全加载之后才能得到。最简单的办法是在<code>window.onload</code>事件中读取各种数据。</p></blockquote> <p><strong>1. 页面加载</strong></p> <blockquote><p>一个页面的请求到响应再到显示出来，需要经过下面一些重要过程，当我们在浏览器输入一个<code>URL</code>或者说点击一个<code>URL</code>开始，会出现如下流程</p></blockquote> <ul><li>页面准备</li> <li>重定向：在<code>header</code>定义了重定向才会有这个过程，如果没有重定向，不会产生这个过程。</li> <li><code>app cache</code>：会先检查这个域名是否有缓存，如果有缓存就不需要DNS解析域名。这里的<code>app</code>是值应用程序<code>application</code>，不指手机<code>app</code>。</li> <li><code>DNS</code>解析：把域名解析成<code>IP</code>，如果直接用<code>ip</code>地址访问，不产生这个过程。</li> <li><code>TCP</code>连接：<code>http</code>协议是经过<code>TCP</code>来传输的，所以产生一个<code>http</code>请求就会有<code>TCP connect</code>，但是依赖于长连接，不会产生这个过程。</li> <li><code>request header</code>：请求头信息。</li> <li><code>request body</code>：请求体信息，比如<code>get</code>请求是没有请求体信息的，所以没有这个过程，这就是为什么把头跟体分开写的原因。</li> <li><code>response header</code>：响应头信息。</li> <li><code>response body</code>：响应体信息。</li> <li>解析<code>HTML</code>结构</li> <li>加载外部脚本和样式表文件：正常来说<code>JS</code>、<code>css</code>都是外部加载的，当然有不正常的人啊，比如我。</li> <li>解析并执行脚本代码</li> <li>构建与解析<code>HTML DOM</code>树：这个过程可以去了解下<code>DOM</code>树是怎样的就明白啦。</li> <li>加载外部图片</li> <li>页面加载完成，显示出来啦</li></ul> <p><strong>2. 重定向分析</strong></p> <ul><li><code>app cach</code></li> <li><code>DNS</code>解析</li> <li><code>TCP</code>连接</li> <li><code>request header</code></li> <li>重定向</li> <li><code>app cach</code></li> <li><code>DNS</code>解析</li> <li><code>TCP</code>连接</li> <li><code>request header</code></li></ul> <p><strong>3. performance.timing</strong></p> <blockquote><p>这个API能帮我们得到整个页面请求的时间，如下图，在<code>Chrome</code>的<code>Console</code>是可以直接运行的</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503170506.png" loading="lazy" class="lazy"></p> <p>先解释下这些时间都是代表什么</p> <p><strong>timing 对象里边的数据比较多，梳理如下几个关键性的节点</strong></p> <ul><li><code>fetchStart</code>：发起获取当前文档的时间点，我的理解是浏览器收到发起页面请求的时间点；</li> <li><code>domainLookupStart</code>：返回浏览器开始<code>DNS</code>查询的时间，如果此请求没有<code>DNS</code>查询过程，如长连接、资源<code>cache</code>、甚至是本地资源等，那么就返回<code>fetchStart</code>的值；</li> <li><code>domainLookupEnd</code>：返回浏览器结束<code>DNS</code>查询的时间，如果没有<code>DNS</code>查询过程，同上；</li> <li><code>connectStart</code>：浏览器向服务器请求文档，开始建立连接的时间，如果此连接是一个长连接，或者无需与服务器连接（命中缓存），则返回<code>domainLookupEnd</code>的值；</li> <li><code>connectEnd</code>：浏览器向服务器请求文档，建立连接成功的时间；</li> <li><code>requestStart</code>：开始请求文档的时间（注意没有<code>requestEnd</code>）;</li> <li><code>responseStart</code>：浏览器开始接收第一个字节数据的时间，数据可能来自于服务器、缓存、或本地资源；</li> <li><code>unloadEventStart</code>：卸载上一个文档开始的时间；</li> <li><code>unloadEventEnd</code>：卸载上一个文档结束的时间；</li> <li><code>domLoading</code>：浏览器把<code>document.readyState</code>设置为<code>“loading”</code>的时间点，开始构建<code>dom</code>树的时间点；</li> <li><code>responseEnd</code>：浏览器接收最后一个字节数据的时间，或连接被关闭的时间；</li> <li><code>domInteractive</code>：浏览器把<code>document.readyState设</code>置为<code>“interactive”</code>的时间点，<code>DOM</code>树创建结束；</li> <li><code>domContentLoadedEventStart</code>：文档发生<code>DOMContentLoaded</code>事件的时间；</li> <li><code>domContentLoadedEventEnd</code>：文档的<code>DOMContentLoaded</code>事件结束的时间；</li> <li><code>domComplete</code>：浏览器把<code>document.readyState</code>设置为<code>“complete”</code>的时间点；</li> <li><code>loadEventStart</code>：文档触发<code>load</code>事件的时间；</li> <li><code>loadEventEnd</code>：文档出发<code>load</code>事件结束后的时间</li></ul> <blockquote><p>再来一张图，表示各阶段的开始与结束对应的时间</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503170539.png" loading="lazy" class="lazy"></p> <blockquote><p>从以上的分析，我们就可以得到一些时间的计算</p></blockquote> <ul><li>准备新页面耗时：<code>fetchStart - navigationStart</code></li> <li>重定向时间：<code>redirectEnd - redirectStart</code></li> <li><code>App Cache</code>时间：<code>domainLookupStart - fetchStart</code></li> <li><code>DNS</code>解析时间：<code>domainLookupEnd -domainLookupStart</code></li> <li><code>TCP</code>连接时间：<code>connectEnd - connectStart</code></li> <li><code>request</code>时间：<code>responseEnd - requestStart</code>这个计算是代表请求响应加起来的时间</li> <li>请求完毕到<code>DOM</code>树加载：<code>domInteractive -responseEnd</code></li> <li>构建与解析<code>DOM</code>树，加载资源时间：<code>domCompleter -domInteractive</code></li> <li><code>load</code>时间：<code>loadEventEnd - loadEventStart</code></li> <li>整个页面加载时间：<code>loadEventEnd -navigationStart</code></li> <li>白屏时间：<code>responseStart-navigationStart</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">let</span> timing <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing

<span class="token comment">// DNS 解析耗时</span>
timing<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>domainLookupStart

<span class="token comment">// TCP 连接耗时</span>
timing<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>connectStart

<span class="token comment">// SSL 安全连接耗时</span>
timing<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>secureConnectionStart

<span class="token comment">// 网络请求耗时</span>
timing<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart

<span class="token comment">// 数据传输耗时</span>
timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>responseStart

<span class="token comment">// DOM 解析耗时</span>
timing<span class="token punctuation">.</span>domInteractive <span class="token operator">-</span> timing<span class="token punctuation">.</span>responseEnd

<span class="token comment">// 资源加载耗时</span>
timing<span class="token punctuation">.</span>loadEventStart <span class="token operator">-</span> timing<span class="token punctuation">.</span>domContentLoadedEventEnd 

<span class="token comment">/* 关键性能指标 */</span>

<span class="token comment">// 首包时间</span>
timing<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> timing<span class="token punctuation">.</span>domainLookupStart

<span class="token comment">// 白屏时间</span>
timing<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart 

<span class="token comment">// 首次可交互时间</span>
timing<span class="token punctuation">.</span>domInteractive <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart 

<span class="token comment">// HTML 加载完成时间， 即 DOM Ready 时间</span>
timing<span class="token punctuation">.</span>domContentLoadedEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart

<span class="token comment">// 页面完全加载时间</span>
timing<span class="token punctuation">.</span>loadEventStart <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart
</code></pre></div><p><strong>4. performance.getEntries()</strong></p> <blockquote><p>这个API能帮我们获得资源的请求时间，包括JS、CSS、图片等</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503170603.png" loading="lazy" class="lazy"></p> <blockquote><p>如上图可以看到这个API请求返回的是一个数组，这个数组包括整个页面所有的资源加载，上图打开了一个其中一个资源，可以看到如下信息</p></blockquote> <ul><li><code>entryType</code>：类型为<code>resource</code></li> <li><code>name</code>：资源的<code>url</code></li> <li><code>initiatorType</code>：资源是<code>link</code></li> <li>资源时间：<code>duration</code>的值，是<code>responseEnd - startTime</code>得到的</li></ul> <p><strong>performance.memory</strong></p> <blockquote><p>这个API主要是得到浏览器内存情况</p></blockquote> <ul><li><code>jsHeapSizeLimit</code>：内存大小限制</li> <li><code>totalJSHeapSize</code>：可使用的内容</li> <li><code>userdJSHeapSize</code>：已使用的内容</li></ul> <blockquote><p><code>userdJSHeapSize</code>表示所有被使用的JS堆栈内存，<code>totalJSHeapSize</code>可使用的JS堆栈内存，如果<code>userdJSHeapSize</code>的值大于<code>totalJSHeapSize</code>，就可能出现内存泄漏</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503170616.png" loading="lazy" class="lazy"></p> <p><strong>5. getEntriesByType</strong></p> <p>这个 <a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEntry/entryType" target="_blank" rel="noopener noreferrer">API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以让我们通过传入 <code>type</code> 获取一些相应的信息：</p> <ul><li>frame：事件循环中帧的时间数据。</li> <li>resource：加载应用程序资源的详细网络计时数据</li> <li>mark：<code>performance.mark</code> 调用信息</li> <li>measure：<code>performance.measure</code> 调用信息</li> <li>longtask：长任务（执行时间大于 50ms）信息。这个类型已被废弃（文档未标注，但是在 Chrome 中使用会显示已废弃），我们可以通过别的方式来拿</li> <li>navigation：浏览器文档事件的指标的方法和属性</li> <li>paint：获取 FP 和 FCP 指标</li></ul> <p>最后两个 <code>type</code> 是性能检测中获取指标的关键类型。当然你如果还想分析加载资源相关的信息的话，那可以多加上 <code>resource</code> 类型。</p> <p><strong>6. PerformanceObserver</strong></p> <p><code>PerformanceObserver</code>也是用来获取一些性能指标的 API，用法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> perfObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 信息处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 传入需要的 type</span>
perfObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'longtask'</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>结合 <code>getEntriesByType</code> 以及 <code>PerformanceObserver</code>，我们就能获取到所有需要的指标了。</p></blockquote> <h3 id="错误监控"><a href="#错误监控" class="header-anchor">#</a> 错误监控</h3> <p><strong>js 运行时报错</strong></p> <blockquote><p>为了更好的保证网站正常的运行，我们会通过<code>window.onerror</code>捕获，js具体的堆栈信息和错误行和列。一般我们的js都是打包压缩、混淆后上传到cdn的（无法定位到具体错误）。因此在打包时，同时生产<code>.map</code>文件，用 <code>sourcemap</code> js库（nodejs）来还原具体错误信息</p></blockquote> <p><strong>资源加载出错</strong></p> <blockquote><p>为了防止加载资源失败，而导致网站打不开。一般我们会通过 <code>window.addEventListener('error')</code> 对资源加载进行监控。</p></blockquote> <p><strong>后端api接口监控</strong></p> <blockquote><p>一般对于小公司而言，可能连后端都很少会有接口方面的监控。一旦出现问题，却又不好排查问题，因此我们可以通过对浏览器底层的xhr对象进行拦截，上报相关调用数据和接口耗时。一方面可以检测到接口的实时调用情况，同时也方便后期对接口的数据统计。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503175341.png" loading="lazy" class="lazy"></p> <h3 id="数据处理和展示"><a href="#数据处理和展示" class="header-anchor">#</a> 数据处理和展示</h3> <p>用到 <code>es（elasticsearch）</code>来对数据进行实时查询和分析。可是怎么把数据推到es里面呢？这对于前端同学来说，这又是一个难点。别急，“logstash” 了解一下。logstash主要对数据进行采集、分析、过滤的工具，然后推送到es里面。数据既然有了，那么怎么展示呢？这时候 Kibana 出来了，来作为数据展示的承托。这就是后端开源届的日志分析系统“ELK”。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503175506.png" loading="lazy" class="lazy"></p> <p>其实对于数据的展示，可以不用kibana或者其他开源的产品进行展示，也可以自己通过es的restful接口，来搭建数据展示</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503175531.png" loading="lazy" class="lazy"></p> <h2 id="十、前端监控系统实战"><a href="#十、前端监控系统实战" class="header-anchor">#</a> 十、前端监控系统实战</h2> <h3 id="没有前端监控下的痛点有哪些"><a href="#没有前端监控下的痛点有哪些" class="header-anchor">#</a> 没有前端监控下的痛点有哪些</h3> <ul><li>用户反馈点击某个按钮没有任何反应。（没办法知道用户点了按钮，为什么没反应呢？是js报错导致，还是其它原因导致？）</li> <li>用户反馈打开页面很慢。（没办法感知用户慢在什么地方）</li> <li>调用后端api接口出错，无法第一时间感知。（只能被动等待用户告诉和自己去发现）</li> <li>网站静态资源加载出错，导致网站打不开。</li> <li>上报的js错误信息，怎么反解析出源代码报错位置。</li></ul> <p><img alt="" data-src="https://s.poetries.work/images/20210503175936.png" loading="lazy" class="lazy"></p> <h3 id="手动搭建一个前端监控系统"><a href="#手动搭建一个前端监控系统" class="header-anchor">#</a> 手动搭建一个前端监控系统</h3> <p>在搭建前端监控系统开始之前，我们先来了解下整个系统的架构是怎么样的。因为你只有了解到流程是怎样走的，才清楚每个步骤我们该做些什么事情。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180034.png" loading="lazy" class="lazy"></p> <h3 id="js-sdk-功能设计"><a href="#js-sdk-功能设计" class="header-anchor">#</a> JS SDK 功能设计</h3> <p><strong>1. 监控js错误信息上报</strong></p> <p>通过<code>window.onerror</code>方法，对页面js错误进行监控。上报具体的错误信息和堆栈信息（如下图），利用<code>webpack/gulp打包出来的.map文件</code>，来解析出具体的错误信息。</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180112.png" loading="lazy" class="lazy"></p> <p>nodejs通过上传.map文件，解析出具体错误信息。代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sourceMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'source-map'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> _sourceMap <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token comment">// 通过sourceMap库转换为sourceMapConsumer对象  </span>
<span class="token keyword">let</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">sourceMap<span class="token punctuation">.</span>SourceMapConsumer</span><span class="token punctuation">(</span>_sourceMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 传入要查找的行列数，查找到压缩前的源文件及行列数  </span>
<span class="token keyword">let</span> sm <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">originalPositionFor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">line</span><span class="token operator">:</span> line<span class="token punctuation">,</span> <span class="token literal-property property">column</span><span class="token operator">:</span> column
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 压缩前的所有源文件列表  </span>
<span class="token keyword">let</span> sources <span class="token operator">=</span> consumer<span class="token punctuation">.</span>sources<span class="token punctuation">;</span>
<span class="token comment">// 根据查到的source，到源文件列表中查找索引位置  </span>
<span class="token keyword">let</span> smIndex <span class="token operator">=</span> sources<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 到源码列表中查到源代码  </span>
<span class="token keyword">let</span> smContent <span class="token operator">=</span> consumer<span class="token punctuation">.</span>sourcesContent<span class="token punctuation">[</span>smIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 将源代码串按&quot;行结束标记&quot;拆分为数组形式  </span>
<span class="token keyword">const</span> rawLines <span class="token operator">=</span> smContent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\r?\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出源码行，因为数组索引从0开始，故行数需要-1  </span>
<span class="token keyword">let</span> errInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
errInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">line</span><span class="token operator">:</span> sm<span class="token punctuation">.</span>line <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> rawLines<span class="token punctuation">[</span>sm<span class="token punctuation">.</span>line <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
errInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">line</span><span class="token operator">:</span> sm<span class="token punctuation">.</span>line <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> rawLines<span class="token punctuation">[</span>sm<span class="token punctuation">.</span>line <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
errInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">line</span><span class="token operator">:</span> sm<span class="token punctuation">.</span>line<span class="token punctuation">,</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> rawLines<span class="token punctuation">[</span>sm<span class="token punctuation">.</span>line<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 

<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> errInfo<span class="token punctuation">,</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'success'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>首先在管理后台，上传对应错误js的map文件，最终还原效果图如下：</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180234.png" loading="lazy" class="lazy"></p> <p>通过上图，我们可以快速定位错误的具体位置，大大节省了排查错误的时间。</p> <p><strong>2. api接口调用请求上报</strong></p> <blockquote><p>可能有些朋友会好奇，怎么去实时监听ajax异步接口请求情况呢？其实很简单：首先我们先通过代理XMLHttpRequest对象，来实现对ajax异步请求进行数据劫持。如下图：</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503180304.png" loading="lazy" class="lazy"></p> <p>通过上图不难发现，我们通过xhr对象的<code>onreadystatechange</code>事件进行劫持，针对后端api接口返回的数据，进行处理上报接口的调用情况，因此达到实时监控接口调用情况，是不是觉得很神奇！</p> <p>如有同学想了解这块内容具体的代码，github社区有开源的模块，可自行查看： <a href="https://github.com/wendux/Ajax-hook" target="_blank" rel="noopener noreferrer">https://github.com/wendux/Ajax-hook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>根据需要统计哪些数据进行上报，比如<code>:page query</code>参数、api接口请求数据...方便后续出错，定位问题。如下图：</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180352.png" loading="lazy" class="lazy"></p> <p><strong>3. 页面性能数据上报</strong></p> <blockquote><p>关于页面性能数据，我们一般通过浏览器<code>performance.timingAPI</code>来进行上报</p></blockquote> <p><strong>各阶段耗时图</strong></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180431.png" loading="lazy" class="lazy"></p> <p><strong>关键性能指标图</strong></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180455.png" loading="lazy" class="lazy"></p> <p><strong>4. 能支持自定义数据上报</strong></p> <blockquote><p>上述一般都是自动进行错误采集进行上报，但有些情况是需要我们手动调用进行上报（自定义数据的埋点）。因此sdk的设计，最好支持手动调用上报。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> report <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    参数配置<span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// get 上报</span>
report<span class="token punctuation">.</span><span class="token function">getRport</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">xxx</span><span class="token operator">:</span> <span class="token number">111</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Consoel<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上报回调的数据：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// post 上报</span>
report<span class="token punctuation">.</span><span class="token function">postRport</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">xxx</span><span class="token operator">:</span> <span class="token number">111</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Consoel<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上报回调的数据：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>关于SDK设计的时候，需要注意的以下几点：</strong></p> <ul><li>SDK上报采用哪种方式比较好。一般来说采用<code>get</code>（<code>image</code>方式上报，因为它避免的跨域的限制，目前也是业界主流的上报方式）</li> <li>在SDK上报方式，最好设计<code>get</code>和<code>post</code>两种方式上报。因为有些复杂的数据结构，采用post上报，在服务端解析会比较方便。</li> <li>当网站每天的pv很大时，要支持抽样上报，减少服务器资源。（一般做法，通过每次随机一个数值，来跟预设定的值做比较）</li> <li>如有想对一些错误信息不需要上报，要支持排查哪些错误信息上报。</li> <li>如果针对<code>get</code>上报时，一般是在<code>xx.gif</code>后带参数，一定要对参数进行转义，不然在某些场景下会报错！</li> <li>针对采集<code>page</code>参数时，也要进行<code>encodeURIComponent</code>进行转义，不然在某些场景下会报错！</li> <li>要支持站点级别的功能，因为你想要接入不同的项目。就得根据不同的做区分和报警设置。思路很简单通过增加一个站点id值，来作为后续数据的筛选条件。比如：<code>pid</code></li></ul> <h3 id="服务端接收数据-并记录日志"><a href="#服务端接收数据-并记录日志" class="header-anchor">#</a> 服务端接收数据，并记录日志</h3> <blockquote><p>sdk设计好了，上报数据也有了。现在我们开始设计服务怎么接收和处理数据。以Nodejs为例：</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503180707.png" loading="lazy" class="lazy"></p> <blockquote><p>通过上图不难发现，我们通过接收到参数，然后通过decode解析出参数，并对参数进行处理。利用 nodejs <code>file-stream-rotator</code> 这个库，把数据写入本地到日志中。(不过在写入日志的时候，记得对一些数据进行校检。</p></blockquote> <p>比如：不存在站点id，不给写入。对于外部网站的接口请求，不给写入。通过实战来看，有些情况，竟然会把UC浏览器部分请求给抓上来，所以需要过滤处理)</p> <h3 id="数据收集与过滤"><a href="#数据收集与过滤" class="header-anchor">#</a> 数据收集与过滤</h3> <blockquote><p>当数据写入日志文件中，通过Logstash监测日志变化，收集到数据并对数据进行格式化和过滤处理，并收集推送到ES（数据存储）。</p></blockquote> <p>比如利用<code>geoip</code>和<code>useragent</code>插件，分别对ip和浏览器的UA进行解析，分别得到对应的地理位置信息和浏览器相关距离信息。如下图：</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503180802.png" loading="lazy" class="lazy"></p> <p>关于<code>logstash</code>的安装和配置，在这里不多说啦，可自行google安装配置。（建议使用docker版本，简单省事）</p> <h3 id="数据存储-es-提供分析和查询能力"><a href="#数据存储-es-提供分析和查询能力" class="header-anchor">#</a> 数据存储（ES）提供分析和查询能力</h3> <blockquote><p>通过ES（elasticsearch）提供对应的restful api，手动搭建数据大盘（或者用kibana）。对于es数据管理，前期可以先安装一个es-head的插件，来查看数据情况。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503180831.png" loading="lazy" class="lazy"></p> <blockquote><p>关于修改<code>es header 5.0 request content-type</code> 不对的情况。可以对 <code>/usr/src/app/_site/ vendor.js</code> 文件进行修改。以docker镜像为例：</p></blockquote> <ol><li>从从镜像<code>copy vendor.js</code>文件出来，如：</li></ol> <div class="language- extra-class"><pre class="language-text"><code>docker cp elasticsearch-head:/usr/src/app/_site/vendor.js /Users/duanliang/logstash
</code></pre></div><ol start="2"><li>修改ajax 请求<code>content-type</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>大约在6886行
/contentType: &quot;application/x-www-form-urlencoded
改成
contentType: &quot;application/json;charset=UTF-8&quot;
</code></pre></div><ol start="3"><li>把文件copy回容器</li></ol> <div class="language- extra-class"><pre class="language-text"><code>docker cp /Users/duanliang/logstash/vendor.js elasticsearch-head:/usr/src/app/_site/vendor.js
</code></pre></div><ol start="4"><li>重启镜像</li></ol> <div class="language- extra-class"><pre class="language-text"><code>docker restart elasticsearch-head
</code></pre></div><p>你可能用到的 docker 镜像地址：</p> <div class="language- extra-class"><pre class="language-text"><code>es：docker pull docker.elastic.co/elasticsearch/elasticsearch:6.5.4

es-headder: docker pull mobz/elasticsearch-head:5 

logstash: docker.elastic.co/logstash/logstash:6.5.4 
</code></pre></div><h3 id="告警配置"><a href="#告警配置" class="header-anchor">#</a> 告警配置</h3> <blockquote><p>通过后台配置自定义报警规则，来告警开发人员。原理：通过nodejs启动定时任务来读取配置表，根据不同的规则去读取es里面的数据（一分钟查询一次），如果有错误，则通知报警。</p></blockquote> <p><img alt="" data-src="https://s.poetries.work/images/20210503181001.png" loading="lazy" class="lazy"></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503181010.png" loading="lazy" class="lazy"></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503181017.png" loading="lazy" class="lazy"></p> <p><img alt="" data-src="https://s.poetries.work/images/20210503181025.png" loading="lazy" class="lazy"></p> <p>最终以：首页 Dashboard为例</p> <p><img alt="" data-src="https://s.poetries.work/images/20210503181035.png" loading="lazy" class="lazy"></p></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/1/2022, 12:27:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FE-Interview-Questions/principle-docs/comprehensive/12-正则完整篇.html" class="prev">正则完整篇</a></span> <span class="next"><a href="/FE-Interview-Questions/principle-docs/comprehensive/14-浏览器渲染机制.html">浏览器渲染机制</a>
      →
    </span></p></div>  <div class="location" data-v-1c29d564><!----> <div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAB3lJREFUeF7lW2usHVUV/tY+qU14+AMpT0ONAX/5Q5EgoLxCgq/WBwVEgZT2nNlzKBLR8IiEREiURBTQ3IaeWXOO10DrDx4FrUhrQiAagQIlmBgjlaBEEQUCicVq0s4ss05mTuaee+45e8/MvT2169fJvev5zZ69115rDWGRqd1uH5Om6RoAHwJwtIisIKKj9TeAFZn5NwG8JSJvEVH/N4DdxpiHOp3OG4vpIi2G8mazudIYcyERXQTg0xVtbBeRrWma/qrX671aUdc88VoBsNa2AHwRwOfqdjTT9yiAR5i5W5f+WgAIw/CiNE2vJaLz6nJsnB4RedIYMxNF0daq9ioB0Gq1zjPGXAtAl/qBIH01Zrrd7pNljZcCoNVqvd8Y820AuuSngbppmt7W7Xb/5uuMNwDW2ksAfCfb1X3tLSb/bgC3MPMDPka8ALDW3gXgGz4GDgDv3cz8TVe7zgBYa58CcKar4gPM9zQzn+XigxMA1lpxUTZtPMw8Mb6JDNbaLQC+Om3BOfrzU2a+fBzvWACCILiciDY7GptKNhG5Io5jfYgjaUEArLUfB/DMVEbl79QZzLxzlNhIAJrN5lGNRuOXABSE/wfamSTJZ3u93tvDwYwEwFobT1GSU9cD6DJzMBGALL19oi6rJfT8VUReMMa8ISJ6NT4JwEcAfLiErjkiaZqeP5w2z1sB1tqHDlBu/3sAcaPRuG/Tpk3vDAe7bt26FcuWLfsEAE3BFZAytJWZtTYxoDkA6K1ORBSApabHAVzGzFoImUjW2lszICbyzlvyRGuKt8g5AARB8MRSXWkLjt3BzDf5RpKtCO9qkV6l4zg+P7c3ACArZujmt2RERDuiKJpTMdqwYcMRSZKcKiKnAjgXwH8BvEZEj0VRpCtlQNbaEECnhMNBXlQZABCGoZaePlVCWWkRY8zqTqfzi1xBq9U62xij1R6tH46iO5n5+iEQdgC40MeJIvB9AJrN5smNRuNPPkpq4N3GzJ/P9WT7z08AHDlB90Zm1iJMn8IwbIvIJl9/kiQ5pdfrvdwHwFp7A4A7fJVU4SeiG6Io+kGuw1r7MwADQCbovjS/97fb7dPTNB2Z5U3QcSMzf78PQBAEvyais6sE5CtLRFdGUTS4Z1hr3wVwuKOeOa+CtXYPgCMcZftsIvKbOI7PIWvt8QD+7iNcB28xKfFNvoZ38gqn1wkKwDUANtYRlI+OKgDooi2Wxq21L5Us0X1NAbgbwHU+ztfBWwWANE0/2O12/1zYP/7lsHmOcvuHCsB9AK6oIygfHWUBIKKroyganP3WWgsg8rFd4N1MQRBsJ6IlPf/VgRIA6FPWgqemwQOy1j4P4GNlABCRHboCSisoYzSXcQTgbc0AReTl5cuX3zUzM6MgDCgMw1kRuaqCH7sUgL8AWFlBySjR/wDQxOp9AE4cxeACgIjcE8exbtLzqKa961UF4N8ADqsJAD3LNxpjNnY6ndfWr19/ZKPRiIjoK8P6XQAAMEh4ChveJwGsralgs7c2AESkkzUs/1AMNgiCq4hotiQA2/bt29ecnZ19MwiCVcaYtSJycU0PS9X0AajjFZh3SSk8sRsBfK8kALnYPwAcV2Pguar+K1B1E/wxMzeLzumVdv/+/dcT0Rkiot2k91YEYBFi76vcVfUY3MXMpxW9y6o1els7apzXjnvAYgXe15sfg1USoZCZubDctV4355xeKIJpAADA5iqp8LvMPLi7h2F4mog85/rIpgSAfip8NYB7XB3P+TQ5ieP4lMLTvxnAd131TAkAGygbY/unq+MFAOYUF32vpNMAgDHm2Lwi9FiJcbY9zDzY3YMg+BYR3e4I5LDsGiJ60FG2LrbtzPyZvCIUENFgM3O1ICIfjeP4ReW31mphUguULvQAM19aeH30Oq7X8iUjEbFxHMd5UXRlo9HQhMiLciWFQFxOlD0isjaO44cLcj8HsNrLeEXmJEk+oIOXxb6Alqd9BxyfY+bTi75M6Nq8ZIxpdjqd3+Yy7XZ7VZqm2yrG4yv+KDOvUqHKjRERuT+O4y8XPQiC4Cwi0pxdG5vvAbBTRHbu3bv32S1btsy50taQifoGr/zzGyP9v5ZsjYnIF+I41mXsRdbaewFc6SVUkXnB1pjqrdgcvZWZb3PxL7sr3Kl7pwt/nTw0rjmqhiq2x3Wp367LvdvtzsstsoamVSf0BKkzMEdd49vjqsS3Rj/G8B8B/I6IXgFwvIic4NvDcwzKmc1pQCJbBYfuiEy2CnQYWlvRC3VpnVGfEsbdaZpeMGqYetyYnA5F3z8lAVR1Y15tMVc4dlDyIBmOngTO2OFpl1HZg2lIehiMiUPTEwHINsVDd1g6h/QgG5qeOCTttAcMr6eDYXh60nD0cExOr0BRKBui/tEUzhHrmMzXFxqKXmin9AZAFWXD1NrsmJqPppIkuWnUMPSkI6IUALnSQ/azuWFUD9kPJ4eB0GlTLYQs1sClDjiKyINT9+nsMBDZ4OWXRGR11fE7HWcjom1Jkjysg42T3mnf/1faA1yMZWN4+mntyZ6fz2uwen9/3cVOWZ7/AX1NhacO32+lAAAAAElFTkSuQmCC" class="pic" data-v-1c29d564></div> <div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,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" class="pic" data-v-1c29d564></div> <a href="http://nav.poetries.top" target="_blank" data-v-1c29d564><div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,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" class="pic" data-v-1c29d564></div></a> <!----> <div class="el-tooltip item item" style="display:none;" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABMZJREFUeF7tWk2IHFUQrhpmEcR4EFQwl+DBg4dAUAKKh4hiMCwJGiJGUDK786p7VzaIJhdFzB5UMAYxkMWuN+NGFxQEFY0QFUNyyEGIHjwoKIKelBgQBZVdmHklFXqWtt3d6Tfduw3b/WAPO1O/39SrqlfvIVR8YcX9hxqAOgIqjkC9BSoeAHUSLG0LtFqtG5vN5nsagb1e75H5+fkrZURjaQAYY6YR8ZQ6LSJPWmvnKgUAER0DgBdip2eZWf/f8FVaBNQA1BFQ8S3Qbrd3NRqN87rpnXP3djqdCxueAADK7QPa7fYd6nSn0/m6DOdVp3cSNMbsRsQ3AOAPRDwZRdF8WcarXiJ6GQAeFZGfFxcXxxcWFv72sccbACI6CgCvJJQcY+ZZH6VF0M7MzFyztLT0JgA8NpAnIjuttZd85HsDEATB7SLybVIJItooiiiL4unp6et6vd7dInIzAOifrsuIeBkALjLzP8PktFqtW8fGxt4CgHsStJeYeecw3vT33gCogDiBaehvSwg8wcxHVjOAiNoA8DAAPDjEyA8A4Cwzd1ajM8acR8Rdie8/BYAJZv51QwBQJcaY2wAgGhiCiKejKGqlDTDG7EXEwwBwn6dx50TkpLX24zQfEf2UAJ+ZOfCUvUw+UgQMuCcmJrY0m81ZEdkhIrPpUkZEzwLAi6Map3yI+G4URcv7PAb/EAAcQEQN+1wtdC4A1nKMiCSP42leZl4XW9dFaBAE74jIwSIBAIDnmPmlgmX69wHDDIj3/EfD6Eb5XkT2rZQTRpE14Ck8AojoixESXlYfzjHz/VmJs9AVCkBc6mwWxTlozFol0ldu0QC8H9d6Xzt86LVH2OPDsBZtYQAQ0bUA4NWHj+pEs9ncMjc399eo/Em+TAAYYw4hYrLr0yPshWTdJ6IHAOCzIozKIGM3M38+oAvDcIdzbt8KpXNojzAUgNTo6j86kud4Y8zjiPh2BuNzk4jIE9baBRUUhuE255x2hiutM8y8N9cWICIdXR9YSUhymmuMOYKIx3N7l0GAiBy11r6qpFNTU9v7/f43q9h3xVp7Uy4AlJmIIhHR3n95IeInzHxi8EFZAKj+IAhmnHN60EqvwFr7Q24AMvwoejgqZQtksW1DACgzCeYBYWgSzCp8U5dBDxCq2wjFyVKnPtVthWMQqnsYUgAqfxyO63J1ByKDhFmJkVj8yuN5RJwBgP/d8a/XUJSIujoGF5EPEbHFzH9mrVRpupH7AL0bQMTXEXF7LPQXZt6aVrBOY3F1+PpY1/f9fn+82+3+OAoIIwGQfN6SUPo0M7+2mhEFX4ycQsTppC7n3F2dTudLXxC8AQjDcNw5dyapyGdYWcTVWFxuFeynUg7f4ns75A2AMWYCEXUP6voNAPYz80Vf5IugJ6JnAODqsViXiOyx1p71ke0NQBiGW51zhxFR9/vxKIpWPIv7GJGHNgiCgyLyEAB8N8otkTcAeYxN82oi1c/Keh2iuksDQF+HNBqNr9QI59ydZb0SKQ2A+plc/Uyu4s/kKr8F4suWqy/MRKRlrT1dZIXJKqu0JDg5OXlDo9HQEZpWgf3dbvf3rEYXSVcaAEU6kUdWDUAe9DYDbx0Bm+FXzONDHQF50NsMvJWPgH8BZ+4JX3pL2ngAAAAASUVORK5CYII=" class="pic" data-v-1c29d564></div> <div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,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" class="pic" data-v-1c29d564></div> <a href="/FE-Interview-Questions/principle-docs/comprehensive/12-正则完整篇.html" class="el-tooltip" data-v-1c29d564 data-v-1c29d564><div class="item" data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" style="transform:rotate(90deg);" data-v-1c29d564></div></a> <a href="/FE-Interview-Questions/principle-docs/comprehensive/14-浏览器渲染机制.html" class="el-tooltip" data-v-1c29d564 data-v-1c29d564><div class="item" style="transform:rotate(270deg);" data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" data-v-1c29d564></div></a> <div class="el-tooltip item item" style="display:none;" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAK9JREFUaEPtmEEOgCAMBOGzPIrP6s2o0UPpQgXHe7cwUwIxp8m/PPn6ExuINoiBzxoopWzRizv3r7U+TsvrCLEBsT4MiIGa4/5nwIwoqICLLAj80RYDGHASYIScAN3l6xrgNeoejmvA/95CjBAj5DwDYoDd4ta9B7ohEwdjQAzUHIcBMzJxAQbEQM1x/Nw1I2ss4DndCE5WhgEZysYgs4HGPsPLuMiGI781xAAGnAR2B4xIMbUdZB4AAAAASUVORK5CYII=" class="pic" data-v-1c29d564></div> <div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEUAAAAwCAYAAABHYrdbAAAAAXNSR0IArs4c6QAAAflJREFUaEPtmrFLwkEUx7/vcIugf6IIgigKIqqxttqKQIoGf6dLW+211i56CkIOQU6BW2MRREM0FLQFjQ1JrXIvTvsFhsYVxSm+m36Cvvfuw+f3/Hk+AgCtdYqZt4lo3L3uw/UIoJpIJA6y2ewTRVG0TkTHfQii3ZavACyQ1vocwLxAaRKw1k47KK8ABgVKkwAzLzooNwAmBEorlFUAJwKlScAYQ+QuUqnUlFIqycyT/QiHiGoAbo0xe27/DSiyWgkIlDZGCBSB4tcoxBQxRUzxIyCm+HGSniKmiCl+BMQUP07SU74zJYqiJBEN+7H8l3fVrLV3xWLx7F+i/yBowxSttTtPcecq3bD245/woYqhdDp9yMw7oQpol1cptZzL5aqhanLHkQ8ARkIV0CFvxRizFqomB+UFwFCoAjrkLRtjNkPV5KB0Uz9pcGDmzUKhUA4G5aPRHgHYCFXEl7zhG21ckNbaffuMBQTzppR6CNlg473Lw5s85vvdB2KKmCKm+BEQU/w4SU8RU8QUPwJiih8n6SliipjiR6CTKVrrGWbeAjD660g9/EGl1KO19rper1dKpdIzZTKZOWvtRQ/v6S9L/xwuPgWw8peRezlWPFzcjWe0wbjKcHEb9DEUGS5uhTMQ/0O4BMAN1s4G8zZs4hozXyqldvP5/P079iyQZczayqEAAAAASUVORK5CYII=" class="pic" data-v-1c29d564></div> <div class="el-tooltip item item" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABOxJREFUeF7tmF1oHFUUx89ZF0GXPsSHqhU/HkRstWAtRhAfBJXSWmxBUqWC6Jp77yam1YjUr1Irgl9FttYac89M0gcVP+JDP9AKCq1IUbHti7YaFBGtqIgGlVCI2XtkYAKbuLtnZrKTZN1Z2Kf7v+f+z2/OuXfuILT5D9s8f8gAZBXQ5gSyFmjzAsg2wawFshZocwJZC7R5AWSnQNYCWQu0OYH/dQsYY5Yx8wZmPu553v5az7omAK31cwCwJZjAzEeYeavv+4dbqViqcwh8I+IHzNxNRD9U5/EfAEqpVxCxNDNZZu70PO/zVoCgtbYAoGt4fZeI1tYF0Nvbe+Hk5OQ0QtVi59x5vu//upAhGGO2MvNT9Twi4hXW2pNT49MqoLu7e2UulzsqJHgmEf2zECEope5GxD2NvDUE0NPT01GpVP4QkvuNiBYvNADGmBuZ+UPB1wkiurLhHtCgf6rnHSeilQsFglLqMkT8BADOETxtJ6InJQBnM/NeRLy5UTBm3ud53vr5htDf33/W+Pj4IQC4Vij9AWvtfTM1NY/BcDPcBwArhAR3E9Gm+YSgtX4bALoEDyNEtCHye0AgVEpdhYgBhIuE4FuIaMd8QFBKvYCIDwprfwQA64joz1gAQgg3IeJeACgI5bXRWvvGXELQWj8AAGVhzdFKpbJ2aGjo27rHomTaGHM7M78p6Zh5jed5ByVdM8aVUrch4jtSLES8zlobbI51f5HuAlrrYPPY3YwFpRjSeKlU6nTOfSbpEHG9tTZo4Ya/SADCdtiGiNOOkFqRnXPLfN//Slo4yXixWFySz+d/ijBXEZEfQRfvi5DW+kUA2CwEDjabpUT0cxQDcTRKqW8Q8VJhzuNE9HTUuJErYCqg1vp1ANgoLPBloVDoLJfLp6MakXRa6/cAYLWg20lE/VKs6vHYAILJxpj3mXmVsNBBIloTx0w9rVJqFyJK7xv7iWhd3PUSAQj3hKOIKL0O7yGiYlxT1XpjzCZm3iXEGC0UCiuSVFxiAF1dXWd0dHQE5+slgrkyEUkvKzVDKKVWI2JQ+tLv4pkfOqQJU+OJAQQB+vr6lkxMTHwNAIuEBbcRUd07eq254eesE1IiiHiNtVa6wtcNMysAQVSt9dUAcCyC0c3W2pckXTBeLBYX5fP5vyRtM16+Zg0g3A8ilSoz3+V53qtSYlrr36WrLTPf63nesBRLGm8KgPBkuIeZRUOIeKu19kA9Y1rrT6WrLQA8T0QPS8lFGW8agLAdHgGAZ4SFTzvnVvm+//FMnTHmNWa+U5if6LirF7OpAMJ22ImI9wtJ/AgAtxDRF1M6rfV2AHhCmDdKRJdHebJRNU0HEFZCcDW+QzDxPTO/nMvlTgaf3CMkD2NjY/mRkZFK1OSi6FIBEFbCIUS8IYqJKJp8Pn/+wMDAL1G0cTSpAQgrIfj+vjSOoVraXC53/eDg4JHZxqk1P1UAIQTxSGuUWLOOuznbBGstpLUOSvfcBE+wacfdvAIIFjfG7GDmh2JAeJaIHo2hTyRNvQWqXWmtDQAMNnKKiN8BwGPW2rcSZRRz0pwCCLyVSqXFzLw8+APAckS8wDl3ChFPOecOO+eODQ8P/x0zj8TyOQeQ2GlKEzMAKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaFYBKYFtmbBZBbTMo0rJaNtXwL8uSqVQauCBGgAAAABJRU5ErkJggg==" class="pic" data-v-1c29d564></div> <div class="el-tooltip item item" style="display:none;" data-v-1c29d564 data-v-1c29d564><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABRNJREFUeF7tWWtoHFUUPmcGSWJQKAgVadWgqEWKBSEqBmp9FqNBaxGxCTRm50x2NSAtVHyAFh8/rBhssDv33NWkxBcUIy3aCtK0xQcWRRQUEUGioCAWRbHkuXNkJEqS7s6dzc5Ot+zcv/c73/nud899zSA0eMMGHz+kBqQV0OAOpEugwQsg3QTTJZAugQZ3IF0CDV4A6SmQLoF0CTS4A6d1CWQymVW2ba8WkT9mZmYmRkZGppKej0QNGBgYOHd6enqbiKxHxBtKDHZMRMa01q8nZURiBjiOczciPg0AV5oGh4jvikgvM58wYavtT8SAvr6+dtu2j1codhoR71dKjVUYVxG85gZkMpmrLcv6vCJVi8E7mHlXFfGhoTU1oK+v7yLbtieqFY+InUqpg9XylIqvmQFEdDYAnIxLtGVZbZ7nVW3mUj21NOAvADgnLgMCnqampuahoaHpODlrYgAR/QgAFxqE7vR9/2ihUDga4IjoKQB40hAzwcxtdW0AEX0JAFeFiRSRl7TWDy/FENGrANBriD2ote6My4RYK4CIxgFgg0HcXmbeWg7juu5hEbnRwLGLmXfEYUJsBhDR2wCwyTB7+7XWd4Vhcrnc6rm5uSMAcImBq1drPVKtCbEYQEQqWMYGMccmJyc7R0dHjScDEXUAQFBNZ4VxIuLNSqnD1ZhQtQFE9CwAPGYQ8a1lWbd4nvdzVLGO42xBxNdMeMuy1nqe97UJV66/KgOIKNjIBg3J/xaRa7XW31Qq0nXdR0XkOUPcydnZ2bbh4eHfKuUP8Ms2wHXdbhEZNSW1LKvD87yPTbhy/UTkAYBriP+MmduXk2NZBvT399/m+/77ERLewczvRcCFQojoEABsNOwHI0qp0CO0VHzFBsw/bo4BQGuYIMuyuj3Pi+Vdn8lkViLiEURcYzBzJzMHF6rIrSID5h83HwHAKkOGh5j55cgqIgD7+/vbfd8PToZQ4wEgx8z5CJT/QiIbMP+4+RQA1hrIn2Dm4GSIvbmuu1lE9pmIRWST1vodE65SA4I7+3rDOtyjlHowSuLlYohoOwC8YIoXkeu11p+YcJEqgIgCN0NvcMFnLKXUnaaEcfQ7jrMbEQcMXBO2bd+Uz+d/CJ00kyAiegUAHjDgvmLmdSauOPuJaD8AdIVxisj41NRUV9jtM7QCiCgotaDkwtrvTU1NF8T9TjeZlc1mVxSLxWBTNBn/BjNvKcdX1gAiehwAnjEJ8X3//EKh8KsJV4t+x3HWIWJgwgoD/yAzbyuFKWkAEWUBYI9JtG3bV+Tz+e9MuFr2O47ThYjBcjC1R5j5+aWgUwxwHOc+RHzTxOb7/nWFQiE4Fk97c113QER2RxCylZn3LsSVMiC4cZX6a7Mw7l5mNp7HEQTFBom4X52wbbtjYdUuMmD+Y8RPYaoQcbtS6sXYlMdI5DjOPkTcbKBcdF1easClc3Nz35cjKPctL8YxVEXV09PT2tzcPI6IYS/D8gYE2YnoAACUutCMMfM9VSlMIDiXy62Z/6S2slQ6Eele+PP1lD2AiK4BgLcA4OL/CBDxA6XUrQnojyWF67ob579VnLeE8Hhra+uGwcHByf/HVipjUEotLS23B39yReQLrXVQFWdUy2azlxeLxeAGe5mI/GLb9iHf9z9k5j9DT4EzapQxiI30GIohT91SpAbU7dQkJCytgISMrts0aQXU7dQkJCytgISMrts0aQXU7dQkJCytgISMrts0/wBjzqdQgd2RNAAAAABJRU5ErkJggg==" class="pic" data-v-1c29d564></div></div></main> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="微信扫码登录" class="el-dialog el-dialog--center" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">微信扫码登录</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="购买会员" class="el-dialog el-dialog--center" style="margin-top:15vh;width:32%;"><div class="el-dialog__header"><span class="el-dialog__title">购买会员</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="微信扫码登录" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">微信扫码登录</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="站点迁移通知" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">站点迁移通知</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div> <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="绑定邮箱" class="el-dialog el-dialog--center" style="margin-top:15vh;width:30%;"><div class="el-dialog__header"><span class="el-dialog__title">绑定邮箱</span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><!----></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/FE-Interview-Questions/assets/js/app.afe030bd.js" defer></script><script src="/FE-Interview-Questions/assets/js/3.b54a8b6a.js" defer></script><script src="/FE-Interview-Questions/assets/js/5.a9c334eb.js" defer></script><script src="/FE-Interview-Questions/assets/js/248.d1bf3d2f.js" defer></script><script src="/FE-Interview-Questions/assets/js/11.fd3c8703.js" defer></script>
  </body>
</html>
